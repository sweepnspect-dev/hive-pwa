<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#5E6AD2">
<meta name="description" content="Verso — Privacy-first budget tracker. Zero-knowledge, local-only financial tracking with dark mode, keyboard shortcuts, and encrypted sync.">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Verso">
<link rel="apple-touch-icon" href="icons/icon-180.png">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0%25' stop-color='%234338CA'/><stop offset='100%25' stop-color='%235E6AD2'/></linearGradient></defs><rect width='100' height='100' rx='20' fill='url(%23g)'/><text x='50' y='73' text-anchor='middle' fill='white' font-family='system-ui' font-weight='900' font-size='62'>V</text></svg>">
<title>Verso — Privacy-First Budget Tracker</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Satoshi:wght@400;500;700;900&display=swap');
:root{
  --teal:#5E6AD2;--teal-light:#E0E7FF;--teal-dark:#4338CA;
  --indigo:#14B8A6;--indigo-light:#CCFBF1;
  --slate:#0F172A;--slate-700:#334155;--slate-500:#64748B;--slate-400:#94A3B8;--slate-200:#E2E8F0;--slate-100:#F1F5F9;--slate-50:#F8FAFC;
  --amber:#F59E0B;--amber-light:#FEF3C7;
  --red:#EF4444;--red-light:#FEE2E2;
  --blue:#3B82F6;--blue-light:#DBEAFE;
  --white:#FFFFFF;
  --shadow:0 1px 3px rgba(15,23,42,0.08),0 1px 2px rgba(15,23,42,0.04);
  --shadow-md:0 4px 6px rgba(15,23,42,0.07),0 2px 4px rgba(15,23,42,0.04);
  --radius:12px;
}
*{margin:0;padding:0;box-sizing:border-box}
*:focus-visible{outline:2px solid var(--teal);outline-offset:2px;border-radius:4px}
html{font-size:17px;-webkit-text-size-adjust:100%}
@media(prefers-reduced-motion:reduce){*{transition:none !important;animation:none !important}}
body{font-family:'Inter','Segoe UI',system-ui,-apple-system,sans-serif;background:var(--slate-50);color:var(--slate);display:flex;min-height:100vh}

/* ===== SIDEBAR ===== */
.sidebar{
  width:220px;background:var(--white);border-right:1px solid var(--slate-200);
  display:flex;flex-direction:column;padding:20px 0;flex-shrink:0;
  position:fixed;top:0;bottom:0;left:0;z-index:10;
}
.logo{
  display:flex;align-items:center;gap:10px;padding:0 20px;margin-bottom:28px;
}
.logo-icon{
  width:32px;height:32px;background:linear-gradient(135deg,var(--teal-dark),var(--teal));border-radius:8px;
  display:flex;align-items:center;justify-content:center;
  font-weight:700;color:white;font-size:1.1em;
}
.logo-text{font-family:'Satoshi','Inter',system-ui,sans-serif;font-size:1.15em;font-weight:900;color:var(--slate);letter-spacing:-.3px}
.logo-badge{
  font-size:.55rem;background:var(--teal-light);color:var(--teal-dark);
  padding:1px 6px;border-radius:8px;font-weight:600;margin-left:auto;
}

.nav{flex:1;display:flex;flex-direction:column;gap:2px;padding:0 8px}
.nav-item{
  display:flex;align-items:center;gap:10px;padding:9px 12px;
  border-radius:8px;cursor:pointer;color:var(--slate-500);
  font-size:.88rem;font-weight:500;transition:all .15s;border:none;
  background:none;width:100%;text-align:left;font-family:inherit;
}
.nav-item:hover{background:var(--slate-100);color:var(--slate-700)}
.nav-item.active{background:var(--teal-light);color:var(--teal-dark)}
.nav-item svg{width:18px;height:18px;flex-shrink:0}

.nav-divider{height:1px;background:var(--slate-200);margin:12px 12px}

.sidebar-footer{
  padding:12px 20px;border-top:1px solid var(--slate-200);margin-top:auto;
}
.privacy-badge{
  display:flex;align-items:center;gap:6px;
  font-size:.7rem;color:var(--teal-dark);font-weight:500;
}
.privacy-dot{width:6px;height:6px;border-radius:50%;background:var(--teal)}

/* ===== MAIN ===== */
.main{margin-left:220px;flex:1;min-height:100vh;position:relative;overflow-x:hidden}

.topbar{
  padding:16px 24px;display:flex;align-items:center;gap:16px;
  background:var(--white);border-bottom:1px solid var(--slate-200);
  position:sticky;top:0;z-index:5;
}
.topbar h2{font-size:1.2em;font-weight:700;color:var(--slate)}
.topbar-actions{margin-left:auto;display:flex;gap:8px}

.btn{
  display:inline-flex;align-items:center;gap:6px;
  padding:7px 16px;border-radius:8px;font-size:.82rem;font-weight:600;
  cursor:pointer;border:1px solid var(--slate-200);background:var(--white);
  color:var(--slate-700);transition:all .15s;font-family:inherit;
}
.btn:hover{background:var(--slate-50);border-color:var(--slate-400)}
.btn-primary{background:var(--teal);color:white;border-color:var(--teal)}
.btn-primary:hover{background:var(--teal-dark)}
.btn svg{width:16px;height:16px}

.content{padding:20px 24px}

/* ===== DASHBOARD CARDS ===== */
.metrics{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
.metric-card{
  background:var(--white);border:1px solid var(--slate-200);border-radius:var(--radius);
  padding:14px 16px;box-shadow:var(--shadow);
}
.metric-label{font-size:.72rem;text-transform:uppercase;letter-spacing:1px;color:var(--slate-700);margin-bottom:6px}
.metric-value{font-size:1.6em;font-weight:700;color:var(--slate);font-variant-numeric:tabular-nums;letter-spacing:-0.02em}
.metric-change{
  display:inline-flex;align-items:center;gap:3px;
  font-size:.72rem;font-weight:600;margin-top:4px;padding:2px 6px;
  border-radius:6px;
}
.metric-change.up{background:var(--teal-light);color:var(--teal-dark)}
.metric-change.down{background:var(--red-light);color:var(--red)}

/* ===== CHARTS ===== */
.charts-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px}
.chart-card{
  background:var(--white);border:1px solid var(--slate-200);border-radius:var(--radius);
  padding:20px;box-shadow:var(--shadow);
}
.chart-title{font-size:.88rem;font-weight:700;color:var(--slate);margin-bottom:16px}
.chart-canvas{width:100%;display:block}

/* ===== TRANSACTIONS TABLE ===== */
.table-card{
  background:var(--white);border:1px solid var(--slate-200);border-radius:var(--radius);
  box-shadow:var(--shadow);overflow:hidden;
}
.table-header{
  padding:16px 20px;display:flex;align-items:center;gap:12px;
  border-bottom:1px solid var(--slate-200);
}
.table-header h3{font-size:.92rem;font-weight:700}
.table-count{font-size:.72rem;color:var(--slate-700);background:var(--slate-100);padding:2px 8px;border-radius:6px}
.table-search{
  margin-left:auto;padding:6px 12px;border:1px solid var(--slate-200);
  border-radius:8px;font-size:.8rem;outline:none;width:200px;
  font-family:inherit;transition:border-color .15s;
}
.table-search:focus{border-color:var(--teal)}
.table-filter{
  padding:5px 10px;border:1px solid var(--slate-200);border-radius:8px;
  font-size:.78rem;background:var(--white);color:var(--slate-700);
  cursor:pointer;font-family:inherit;
}

table{width:100%;border-collapse:collapse}
thead th{
  text-align:left;padding:8px 16px;font-size:.7rem;text-transform:uppercase;
  letter-spacing:.8px;color:var(--slate-500);border-bottom:1px solid var(--slate-200);
  font-weight:600;background:var(--slate-50);
}
tbody td{padding:8px 16px;font-size:.84rem;border-bottom:1px solid var(--slate-100)}
tbody tr:hover{background:var(--slate-50)}
tbody tr:last-child td{border-bottom:none}

.cat-badge{
  display:inline-block;padding:2px 10px;border-radius:6px;
  font-size:.7rem;font-weight:600;
}
.amount-pos{color:var(--teal-dark);font-weight:600}
.amount-neg{color:var(--slate);font-weight:600}

/* ===== IMPORT MODAL ===== */
.modal-overlay{
  position:fixed;inset:0;background:rgba(15,23,42,0.4);
  display:none;align-items:center;justify-content:center;z-index:50;
  backdrop-filter:blur(4px);
}
.modal-overlay.open{display:flex}
.modal{
  background:var(--white);border-radius:16px;padding:28px;
  width:540px;max-height:80vh;overflow-y:auto;box-shadow:0 25px 50px rgba(0,0,0,0.15);
}
.modal h3{font-size:1.25em;font-weight:700;margin-bottom:4px}
.modal .subtitle{font-size:.92rem;color:var(--slate-500);margin-bottom:20px}

.drop-zone{
  border:2px dashed var(--slate-200);border-radius:12px;
  padding:40px 20px;text-align:center;cursor:pointer;
  transition:all .2s;margin-bottom:16px;
}
.drop-zone:hover,.drop-zone.drag{border-color:var(--teal);background:var(--teal-light)}
.drop-zone p{color:var(--slate-500);font-size:.88rem;margin-top:8px}
.drop-zone .icon{font-size:2em;margin-bottom:4px}

.preview-table{
  width:100%;border-collapse:collapse;font-size:.78rem;margin:16px 0;
}
.preview-table th{background:var(--slate-100);padding:6px 10px;text-align:left;font-weight:600}
.preview-table td{padding:5px 10px;border-bottom:1px solid var(--slate-100)}

.modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:16px}

/* ===== EMPTY STATE ===== */
.empty-state{
  text-align:center;padding:60px 20px;
}
.empty-state .icon{font-size:3em;margin-bottom:12px;opacity:0.5}
.empty-state h3{font-size:1.1em;font-weight:700;color:var(--slate);margin-bottom:6px}
.empty-state p{color:var(--slate-500);font-size:.88rem;max-width:360px;margin:0 auto 20px}

/* ===== BUDGET VIEW ===== */
.budget-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
.budget-item{
  background:var(--white);border:1px solid var(--slate-200);border-radius:var(--radius);
  padding:16px 18px;box-shadow:var(--shadow);
}
.budget-item-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.budget-item-name{font-size:.84rem;font-weight:600}
.budget-item-amount{font-size:.78rem;color:var(--slate-500);font-variant-numeric:tabular-nums}
.budget-bar{height:6px;background:var(--slate-100);border-radius:3px;overflow:hidden}
.budget-bar-fill{height:100%;border-radius:3px;transition:width .3s}
.budget-pct{font-size:.68rem;color:var(--slate-700);margin-top:4px;text-align:right}

/* ===== BUDGET EDIT ===== */
.budget-item-edit{
  background:none;border:none;cursor:pointer;padding:2px;color:var(--slate-400);
  transition:color .15s;font-size:.9rem;
}
.budget-item-edit:hover{color:var(--teal-dark)}
.budget-summary-card{
  background:var(--white);border:1px solid var(--slate-200);border-radius:var(--radius);
  padding:16px 20px;box-shadow:var(--shadow);margin-bottom:16px;
}
.budget-summary-card h4{font-size:.82rem;font-weight:700;margin-bottom:10px;color:var(--slate)}
.budget-mini-bars{display:flex;flex-direction:column;gap:6px}
.budget-mini-row{display:flex;align-items:center;gap:8px;font-size:.72rem}
.budget-mini-row .bm-name{width:80px;color:var(--slate-500);text-overflow:ellipsis;overflow:hidden;white-space:nowrap}
.budget-mini-row .bm-bar{flex:1;height:4px;background:var(--slate-100);border-radius:2px;overflow:hidden}
.budget-mini-row .bm-fill{height:100%;border-radius:2px;transition:width .3s}
.budget-mini-row .bm-pct{width:35px;text-align:right;color:var(--slate-400);font-weight:600}

/* ===== RECEIPT ===== */
.receipt-btn{
  display:inline-flex;align-items:center;gap:4px;padding:6px 12px;
  border:1px dashed var(--slate-200);border-radius:8px;cursor:pointer;
  background:none;font-size:.78rem;color:var(--slate-500);transition:all .15s;
  font-family:inherit;
}
.receipt-btn:hover{border-color:var(--teal);color:var(--teal-dark)}
.receipt-btn.locked{opacity:0.6;cursor:pointer}
.receipt-thumb{
  width:28px;height:28px;border-radius:4px;object-fit:cover;cursor:pointer;
  border:1px solid var(--slate-200);vertical-align:middle;
}
.receipt-lightbox{
  position:fixed;inset:0;background:rgba(15,23,42,0.85);
  display:flex;align-items:center;justify-content:center;z-index:100;
  backdrop-filter:blur(4px);
}
.receipt-lightbox img{
  max-width:90vw;max-height:85vh;border-radius:12px;
  box-shadow:0 20px 60px rgba(0,0,0,0.4);
}
.receipt-lightbox-close{
  position:absolute;top:16px;right:16px;background:rgba(255,255,255,0.2);
  border:none;color:white;width:44px;height:44px;border-radius:50%;
  font-size:1.4rem;cursor:pointer;display:flex;align-items:center;justify-content:center;
}
.receipt-lightbox-actions{
  position:absolute;bottom:20px;display:flex;gap:8px;
}

/* ===== CATEGORY LEGEND ===== */
.legend{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
.legend-item{display:flex;align-items:center;gap:5px;font-size:.72rem;color:var(--slate-700)}
.legend-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}

/* ===== TOAST ===== */
.toast{
  position:fixed;bottom:20px;right:20px;
  background:var(--slate);color:white;
  padding:10px 20px;border-radius:10px;font-size:.82rem;
  transform:translateY(60px);opacity:0;transition:all .3s;z-index:100;pointer-events:none;
}
.toast.show{transform:translateY(0);opacity:1;pointer-events:auto}
@media(max-width:768px){.toast{bottom:80px;right:16px;left:16px;text-align:center}}

/* ===== SAVINGS GOALS ===== */
.goals-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
.goal-card{
  background:var(--white);border:1px solid var(--slate-200);border-radius:var(--radius);
  padding:18px 20px;box-shadow:var(--shadow);position:relative;overflow:hidden;
}
.goal-card::after{
  content:'';position:absolute;top:0;left:0;right:0;height:3px;
  background:linear-gradient(90deg,var(--green),var(--green-light));
}
.goal-emoji{font-size:1.6em;margin-bottom:8px}
.goal-name{font-size:.92rem;font-weight:700;color:var(--slate);margin-bottom:4px}
.goal-target{font-size:.75rem;color:var(--slate-500);margin-bottom:12px}
.goal-progress{height:10px;background:var(--slate-100);border-radius:5px;overflow:hidden;margin-bottom:6px}
.goal-progress-fill{height:100%;border-radius:5px;transition:width .5s;background:linear-gradient(90deg,var(--green),#34D399)}
.goal-stats{display:flex;justify-content:space-between;align-items:center}
.goal-amount{font-size:.82rem;font-weight:700;color:var(--green-dark)}
.goal-pct{font-size:.72rem;color:var(--slate-400);font-weight:600}
.goal-days{font-size:.68rem;color:var(--slate-400);margin-top:4px}
.add-goal{
  background:var(--slate-50);border:2px dashed var(--slate-200);border-radius:var(--radius);
  padding:30px 20px;text-align:center;cursor:pointer;transition:all .2s;
}
.add-goal:hover{border-color:var(--green);background:var(--green-light)}
.add-goal .icon{font-size:1.5em;margin-bottom:6px}
.add-goal p{font-size:.82rem;color:var(--slate-500);font-weight:500}
.goal-form-modal label{display:block;font-size:.78rem;font-weight:600;color:var(--slate-700);margin-bottom:4px;margin-top:12px}
.goal-form-modal input,.goal-form-modal select{
  width:100%;padding:8px 12px;border:1px solid var(--slate-200);border-radius:8px;
  font-size:.84rem;font-family:inherit;outline:none;
}
.goal-form-modal input:focus,.goal-form-modal select:focus{border-color:var(--green)}

/* ===== MOBILE HEADER ===== */
.mobile-header{
  display:none;align-items:center;gap:12px;
  padding:10px 16px;background:var(--white);
  border-bottom:1px solid var(--slate-200);
  position:fixed;top:0;left:0;right:0;z-index:15;
}
.mobile-header .mh-icon{
  width:36px;height:36px;background:linear-gradient(135deg,var(--teal-dark),var(--teal));border-radius:9px;
  display:flex;align-items:center;justify-content:center;
  font-weight:800;color:white;font-size:1.1em;
}
.mobile-header .mh-name{font-family:'Satoshi','Inter',system-ui,sans-serif;font-size:1.15em;font-weight:900;color:var(--slate)}
.mobile-header .mh-actions{margin-left:auto;display:flex;gap:10px}

/* ===== BOTTOM NAV ===== */
.bottom-nav{
  display:none;position:fixed;bottom:0;left:0;right:0;
  background:var(--white);border-top:1px solid var(--slate-200);
  padding:6px 0 max(6px, env(safe-area-inset-bottom));
  z-index:20;
}
.bottom-nav-items{display:flex;justify-content:space-around;align-items:center}
.bottom-nav-item{
  display:flex;flex-direction:column;align-items:center;gap:3px;
  padding:6px 10px;border:none;background:none;
  color:var(--slate-400);font-size:.65rem;font-weight:600;
  cursor:pointer;font-family:inherit;transition:color .15s;
  -webkit-tap-highlight-color:transparent;min-width:56px;
}
.bottom-nav-item svg{width:26px;height:26px}
.bottom-nav-item.active{color:var(--teal-dark)}

/* ===== SYNC VIEW ===== */
.sync-hero{text-align:center;padding:20px;margin-bottom:20px}
.sync-hero .icon{font-size:2.5em;margin-bottom:8px}
.sync-hero h3{font-family:'Satoshi','Inter',system-ui,sans-serif;font-size:1.1em;font-weight:700;margin-bottom:4px}
.sync-hero p{font-size:.82rem;color:var(--slate-500);max-width:420px;margin:0 auto;line-height:1.5}
.sync-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.sync-card{
  background:var(--white);border:1px solid var(--slate-200);border-radius:var(--radius);
  padding:24px;box-shadow:var(--shadow);
}
.sync-card h4{font-size:.95rem;font-weight:700;margin-bottom:4px;display:flex;align-items:center;gap:8px}
.sync-card p{font-size:.8rem;color:var(--slate-500);margin-bottom:16px;line-height:1.5}
.sync-input{
  width:100%;padding:10px 14px;border:1px solid var(--slate-200);border-radius:8px;
  font-size:16px;font-family:inherit;outline:none;margin-bottom:12px;
}
.sync-input:focus{border-color:var(--teal)}
.sync-drop{
  border:2px dashed var(--slate-200);border-radius:12px;
  padding:24px 16px;text-align:center;cursor:pointer;transition:all .2s;margin-bottom:12px;
}
.sync-drop:hover,.sync-drop.drag{border-color:var(--teal);background:var(--teal-light)}
.sync-drop .icon{font-size:1.3em;margin-bottom:4px}
.sync-drop p{color:var(--slate-500);font-size:.8rem}
.sync-status{padding:10px 14px;border-radius:8px;font-size:.82rem;margin-top:8px;display:none}
.sync-status.show{display:block}
.sync-status.success{background:var(--teal-light);color:var(--teal-dark)}
.sync-status.error{background:var(--red-light);color:var(--red)}
.sync-info{
  font-size:.7rem;color:var(--slate-400);display:flex;align-items:center;gap:6px;
  margin-top:16px;padding-top:12px;border-top:1px solid var(--slate-100);
}
.sync-tech{
  font-family:'SF Mono',Consolas,monospace;font-size:.65rem;color:var(--slate-400);
  background:var(--slate-50);border:1px solid var(--slate-100);
  border-radius:6px;padding:8px 12px;margin-top:8px;
}

@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* ===== TABULAR NUMS GLOBAL ===== */
.amount-pos,.amount-neg,.budget-item-amount,.budget-pct,.bm-pct,.velocity-text .rate,
.metric-change,td:last-child{font-variant-numeric:tabular-nums}

/* ===== PASTE MODAL ===== */
.paste-textarea{
  width:100%;min-height:160px;max-height:300px;padding:12px 14px;
  border:1px solid var(--slate-200);border-radius:8px;font-size:.82rem;
  font-family:'SF Mono',Consolas,monospace;line-height:1.5;resize:vertical;
  outline:none;transition:border-color .15s;background:var(--white);color:var(--slate);
}
.paste-textarea:focus{border-color:var(--teal)}
.paste-textarea::placeholder{color:var(--slate-400)}
html.dark .paste-textarea{background:#14111E;border-color:#352F45;color:#EAE4F0}
.paste-stats{display:flex;gap:8px;margin:10px 0;flex-wrap:wrap}
.paste-stat{
  padding:4px 10px;border-radius:6px;font-size:.72rem;font-weight:600;
  background:var(--slate-50);color:var(--slate-700);
}
html.dark .paste-stat{background:#14111E;color:#D5CFE0}

/* ===== OVERFLOW MENU (mobile) ===== */
.overflow-menu-wrap{position:relative;display:inline-flex}
.overflow-btn{
  display:inline-flex;align-items:center;justify-content:center;
  padding:6px 12px;border:1px solid var(--slate-200);border-radius:8px;
  background:var(--white);cursor:pointer;font-size:1.3rem;color:var(--slate-500);
  font-family:inherit;transition:all .15s;line-height:1;
}
.overflow-btn:hover{background:var(--slate-50);border-color:var(--slate-400)}
html.dark .overflow-btn{background:#14111E;border-color:#352F45;color:#9B95AD}
html.dark .overflow-btn:hover{background:#352F45}
.overflow-dropdown{
  display:none;position:absolute;top:100%;right:0;margin-top:4px;
  background:var(--white);border:1px solid var(--slate-200);border-radius:10px;
  box-shadow:0 8px 24px rgba(0,0,0,0.12);min-width:160px;z-index:30;
  overflow:hidden;
}
.overflow-dropdown.open{display:block}
html.dark .overflow-dropdown{background:#1E1A2B;border-color:#352F45;box-shadow:0 8px 24px rgba(0,0,0,0.4)}
.overflow-dropdown button{
  display:flex;align-items:center;gap:8px;width:100%;padding:10px 14px;
  border:none;background:none;cursor:pointer;font-size:.82rem;font-weight:500;
  color:var(--slate-700);font-family:inherit;text-align:left;transition:background .1s;
}
.overflow-dropdown button:hover{background:var(--slate-50)}
html.dark .overflow-dropdown button{color:#D5CFE0}
html.dark .overflow-dropdown button:hover{background:#14111E}
.overflow-dropdown button.danger-item{color:var(--red)}
html.dark .overflow-dropdown button.danger-item{color:#F87171}
.overflow-divider{height:1px;background:var(--slate-200);margin:2px 0}
html.dark .overflow-divider{background:#352F45}

/* ===== EMPTY STATE ENHANCED ===== */
.empty-cta-grid{
  display:grid;grid-template-columns:1fr 1fr;gap:10px;max-width:380px;margin:0 auto 16px;
}
.empty-cta-btn{
  display:flex;flex-direction:column;align-items:center;gap:6px;padding:16px 12px;
  border:1px solid var(--slate-200);border-radius:var(--radius);background:var(--white);
  cursor:pointer;transition:all .15s;font-family:inherit;
}
.empty-cta-btn:hover{border-color:var(--teal);background:var(--teal-light);transform:translateY(-1px)}
html.dark .empty-cta-btn{background:#1E1A2B;border-color:#352F45;color:#EAE4F0}
html.dark .empty-cta-btn:hover{background:#2D2868;border-color:#A5B4FC}
.empty-cta-btn .cta-icon{font-size:1.4rem}
.empty-cta-btn .cta-label{font-size:.78rem;font-weight:600;color:var(--slate)}
.empty-cta-btn .cta-sub{font-size:.65rem;color:var(--slate-400)}

/* ===== VIEW ALL LINK ===== */
.view-all-link{
  display:block;text-align:center;padding:12px;font-size:.82rem;font-weight:600;
  color:var(--teal-dark);cursor:pointer;border-top:1px solid var(--slate-100);
  transition:background .15s;background:none;border-left:none;border-right:none;border-bottom:none;
  width:100%;font-family:inherit;
}
.view-all-link:hover{background:var(--slate-50)}
html.dark .view-all-link{border-color:#352F45}
html.dark .view-all-link:hover{background:#14111E}

/* ===== DARK MODE ===== */
html.dark{
  --slate:#EAE4F0;--slate-700:#D5CFE0;--slate-500:#9B95AD;--slate-400:#9B95AD;
  --slate-200:#352F45;--slate-100:#1E1A2B;--slate-50:#14111E;
  --white:#1E1A2B;
  --shadow:0 1px 3px rgba(0,0,0,0.3);--shadow-md:0 4px 6px rgba(0,0,0,0.3);
  --teal-light:#2D2868;--teal-dark:#A5B4FC;
  --indigo-light:#1A3B3A;
  --amber-light:#5C3A1A;--red-light:#7F1D1D;--blue-light:#1E2D4F;
}
html.dark body{background:#14111E;color:#EAE4F0}
html.dark .sidebar{background:#0F0C17;border-color:#1E1A2B}
html.dark .topbar{background:#1E1A2B;border-color:#352F45}
html.dark .mobile-header{background:#1E1A2B;border-color:#352F45}
html.dark .bottom-nav{background:#1E1A2B;border-color:#352F45}
html.dark .modal{background:#1E1A2B}
html.dark .modal-overlay{background:rgba(0,0,0,0.6)}
html.dark .drop-zone{border-color:#352F45}
html.dark .drop-zone:hover,.drop-zone.drag{border-color:var(--teal);background:#2D2868}
html.dark .table-search,.dark .table-filter,.dark .sync-input{background:#14111E;border-color:#352F45;color:#EAE4F0}
html.dark thead th{background:#14111E;border-color:#352F45;color:#9B95AD}
html.dark tbody td{border-color:#1E1A2B}
html.dark .preview-table th{background:#14111E}
html.dark .preview-table td{border-color:#1E1A2B}
html.dark .nav-item.active{background:#1A3B3A;color:#A5B4FC}
html.dark .btn{background:#14111E;border-color:#352F45;color:#D5CFE0}
html.dark .btn:hover{background:#352F45}
html.dark .btn-primary{background:var(--teal);color:#14111E;border-color:var(--teal)}
html.dark .sync-tech{background:#14111E;border-color:#352F45;color:#9B95AD}
html.dark canvas{filter:none}
html.dark .velocity-text .detail{color:#9B95AD}
html.dark .sync-hero p{color:#9B95AD}
html.dark .sync-card p{color:#9B95AD}
html.dark .price-note{color:#9B95AD !important}
html.dark .kb-row .kb-desc{color:#D5CFE0}
html.dark .empty-state p{color:#9B95AD}
html.dark .budget-item-edit:hover{color:#A5B4FC}
html.dark details details>summary{filter:brightness(1.8) saturate(0.7)}
html.dark .receipt-btn{border-color:#4A4260;color:#9B95AD}
html.dark .receipt-btn:hover{border-color:#A5B4FC;color:#A5B4FC}
html.dark .receipt-thumb{border-color:#4A4260}
html.dark select,html.dark input[type="text"],html.dark input[type="number"],html.dark input[type="date"],html.dark input[type="password"],html.dark textarea{background:#14111E;border-color:#352F45;color:#EAE4F0}
html.dark .table-row:hover{background:#14111E}
html.dark .tx-modal{background:#1E1A2B}
html.dark .tx-modal-overlay{background:rgba(0,0,0,0.6)}
html.dark .cat-grid-item{border-color:#352F45;color:#D5CFE0}
html.dark .cat-grid-item:hover{border-color:var(--teal)}
html.dark .cat-grid-item.selected{border-color:var(--teal);background:#1A3B3A;color:#A5B4FC}
html.dark .key-input{background:#14111E;border-color:#352F45;color:#EAE4F0}
html.dark .upgrade-panel{background:#1E1A2B}
html.dark .overflow-menu{background:#1E1A2B;border-color:#352F45}
html.dark .overflow-menu-item{color:#D5CFE0}
html.dark .overflow-menu-item:hover{background:#14111E}
html.dark .paste-textarea{background:#14111E;border-color:#352F45;color:#EAE4F0}
html.dark .locked-overlay::after{background:linear-gradient(180deg,transparent 30%,rgba(20,17,30,0.85) 70%,rgba(20,17,30,0.98) 100%)}
html.dark .empty-action-btn{background:#1E1A2B;border-color:#352F45}
html.dark .empty-action-btn:hover{background:#2D2868;border-color:#A5B4FC}

/* ===== PROMO BANNER (free users) ===== */
.promo-banner{
  background:linear-gradient(135deg,var(--teal-light),var(--indigo-light));
  border:1px solid var(--slate-200);border-radius:var(--radius);
  padding:14px 20px;margin-bottom:24px;
  display:flex;align-items:center;gap:14px;cursor:pointer;
  transition:transform .15s,box-shadow .15s;
}
.promo-banner:hover{transform:translateY(-1px);box-shadow:var(--shadow-md)}
.promo-banner .promo-icon{font-size:1.4rem;flex-shrink:0}
.promo-banner .promo-text{flex:1}
.promo-banner .promo-title{font-weight:700;font-size:.85rem;color:var(--slate);margin-bottom:2px}
.promo-banner .promo-desc{font-size:.75rem;color:var(--slate-500)}
.promo-banner .promo-cta{
  font-size:.72rem;font-weight:700;color:white;background:var(--teal);
  padding:6px 14px;border-radius:8px;white-space:nowrap;
}
html.dark .promo-banner{background:linear-gradient(135deg,rgba(20,184,166,0.1),rgba(94,106,210,0.1));border-color:#352F45}
html.dark .promo-banner .promo-title{color:#EAE4F0}
html.dark .promo-banner .promo-desc{color:#9B95AD}

/* ===== VELOCITY CARD ===== */
.velocity-card{
  background:var(--white);border:1px solid var(--slate-200);border-radius:var(--radius);
  padding:18px 20px;box-shadow:var(--shadow);margin-bottom:24px;
  display:flex;align-items:center;gap:16px;
}
.velocity-gauge{width:48px;height:48px;position:relative;flex-shrink:0}
.velocity-text{flex:1}
.velocity-text .label{font-size:.72rem;text-transform:uppercase;letter-spacing:.8px;color:var(--slate-500)}
.velocity-text .rate{font-size:1.1em;font-weight:700;margin:2px 0}
.velocity-text .detail{font-size:.75rem;color:var(--slate-400)}

/* ===== KEYBOARD HELP ===== */
.kb-help{
  position:fixed;inset:0;background:rgba(15,23,42,0.5);display:none;
  align-items:center;justify-content:center;z-index:60;backdrop-filter:blur(4px);
}
.kb-help.open{display:flex}
.kb-panel{
  background:var(--white);border-radius:16px;padding:24px 28px;
  width:420px;max-height:80vh;overflow-y:auto;box-shadow:0 25px 50px rgba(0,0,0,0.15);
}
.kb-row{display:flex;align-items:center;justify-content:space-between;padding:6px 0}
.kb-key{
  font-family:'SF Mono',Consolas,monospace;font-size:.75rem;
  background:var(--slate-100);border:1px solid var(--slate-200);
  padding:2px 8px;border-radius:4px;color:var(--slate-700);font-weight:600;
}
.kb-desc{font-size:.82rem;color:var(--slate-500)}

/* ===== DATA PURGE ===== */
.purge-btn{
  display:flex;align-items:center;gap:6px;
  font-size:.7rem;color:var(--red);font-weight:500;
  cursor:pointer;background:none;border:none;font-family:inherit;
  padding:6px 0;margin-top:8px;opacity:.7;transition:opacity .15s;
}
.purge-btn:hover{opacity:1}

/* ===== RESPONSIVE: TABLET ===== */
@media(max-width:1024px){
  .metrics{grid-template-columns:repeat(2,1fr)}
  .charts-row{grid-template-columns:1fr}
  .budget-grid{grid-template-columns:repeat(2,1fr)}
  .sync-grid{grid-template-columns:1fr}
}

/* ===== RESPONSIVE: PHONE ===== */
@media(max-width:768px){
  html{font-size:21px}
  .sidebar{display:none}
  .main{margin-left:0;padding-bottom:80px;padding-top:60px}
  .mobile-header{display:flex}
  .bottom-nav{display:block}
  .topbar{display:none}
  .content{padding:16px}
  .modal{width:calc(100vw - 20px);max-width:95vw}
  .table-header{flex-wrap:wrap;gap:8px}
  .table-search{width:100%;margin-left:0;order:10;padding:12px 16px;font-size:.88rem}
  .table-filter{padding:10px 16px;font-size:.88rem}
  .table-card{overflow-x:auto;-webkit-overflow-scrolling:touch}
  table{min-width:auto}
  thead th{padding:10px 12px;font-size:.72rem}
  tbody td{padding:12px;font-size:.88rem}
  .sync-grid{grid-template-columns:1fr}
  .goals-grid{grid-template-columns:repeat(2,1fr)}
  .goal-form-modal input,.goal-form-modal select{font-size:16px}
  .btn{padding:12px 22px;font-size:.9rem;border-radius:10px;min-height:44px}
  .btn svg{width:20px;height:20px}
  .cat-badge{padding:3px 10px;font-size:.78rem;border-radius:7px}
  .receipt-btn{padding:8px;border-radius:10px;font-size:0;min-height:38px;min-width:38px;justify-content:center}
  .receipt-btn svg{width:22px;height:22px}
  .receipt-thumb{width:48px;height:48px;border-radius:8px}
  .budget-item-edit{padding:6px;font-size:1rem;min-width:38px;min-height:38px;display:inline-flex;align-items:center;justify-content:center}
  .budget-item{padding:16px 20px}
  .budget-bar{height:8px;border-radius:4px}
  .budget-bar-fill{border-radius:4px}
  .budget-pct{font-size:.76rem;margin-top:4px}
  .budget-item-name{font-size:.9rem}
  .budget-item-amount{font-size:.82rem}
  .empty-state .icon{font-size:3em}
  .empty-state h3{font-size:1.15em}
  .empty-state p{font-size:.9rem}
  .drop-zone{padding:36px 16px}
  .drop-zone p{font-size:.9rem}
  .drop-zone .icon{font-size:2.2em}
}

/* ===== RESPONSIVE: SMALL PHONE ===== */
@media(max-width:480px){
  html{font-size:19px}
  .metrics{grid-template-columns:1fr}
  .budget-grid{grid-template-columns:1fr}
  .goals-grid{grid-template-columns:1fr}
  .content{padding:12px}
  .metric-value{font-size:1.3em}
  .metric-card{padding:12px 14px}
  .drop-zone{padding:28px 12px}
  .modal{padding:20px;border-radius:12px}
  .chart-card{padding:12px}
  .sync-card{padding:14px}
  .legend{gap:6px 10px}
  .legend-item{font-size:.72rem}
  table{min-width:auto}
  thead th{padding:8px 6px;font-size:.68rem;letter-spacing:.3px}
  tbody td{padding:8px 6px;font-size:.82rem}
  .cat-badge{padding:3px 8px;font-size:.7rem}
  .receipt-btn{padding:6px;min-height:34px;min-width:34px;justify-content:center}
  .receipt-btn svg{width:18px;height:18px}
  .receipt-thumb{width:36px;height:36px}
  .velocity-card{flex-wrap:wrap;gap:10px}
  .velocity-text .detail{font-size:.68rem}
}

/* ===== PRO SYSTEM ===== */
.pro-badge{
  display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:20px;font-size:.6rem;
  font-weight:700;letter-spacing:.5px;background:linear-gradient(135deg,#5E6AD2,#8B5CF6);color:white;
  text-transform:uppercase;vertical-align:middle;margin-left:6px;
}
.pro-badge.sidebar{font-size:.55rem;padding:3px 10px;margin:0 0 8px 20px}
.upgrade-cta{
  display:flex;align-items:center;gap:10px;padding:12px 16px;margin:8px 0;
  background:linear-gradient(135deg,rgba(94,106,210,0.08),rgba(139,92,246,0.08));
  border:1px solid rgba(94,106,210,0.2);border-radius:10px;cursor:pointer;
  transition:all 0.2s;
}
.upgrade-cta:hover{background:linear-gradient(135deg,rgba(94,106,210,0.15),rgba(139,92,246,0.15));transform:translateY(-1px)}
.upgrade-cta .icon{font-size:1.3em}
.upgrade-cta .text{flex:1}
.upgrade-cta .title{font-size:.82rem;font-weight:700;color:var(--slate)}
.upgrade-cta .desc{font-size:.68rem;color:var(--slate-400);margin-top:2px}
.upgrade-cta .arrow{color:var(--indigo);font-weight:700;font-size:1.1em}
html.dark .upgrade-cta{background:linear-gradient(135deg,rgba(94,106,210,0.15),rgba(139,92,246,0.15));border-color:rgba(139,92,246,0.3)}
html.dark .upgrade-cta .title{color:#EAE4F0}
html.dark .upgrade-cta .desc{color:#9B95AD}

.locked-overlay{
  position:relative;overflow:hidden;
}
.locked-overlay::after{
  content:'';position:absolute;inset:0;
  background:linear-gradient(180deg,transparent 30%,rgba(248,250,252,0.85) 70%,rgba(248,250,252,0.98) 100%);
  pointer-events:none;z-index:1;border-radius:inherit;
}
html.dark .locked-overlay::after{
  background:linear-gradient(180deg,transparent 30%,rgba(20,17,30,0.85) 70%,rgba(20,17,30,0.98) 100%);
}
.locked-badge{
  position:absolute;bottom:16px;left:50%;transform:translateX(-50%);z-index:2;
  display:flex;align-items:center;gap:6px;padding:8px 16px;
  background:linear-gradient(135deg,#5E6AD2,#8B5CF6);color:white;
  border-radius:20px;font-size:.78rem;font-weight:600;cursor:pointer;
  box-shadow:0 4px 12px rgba(94,106,210,0.3);transition:transform 0.2s;
}
.locked-badge:hover{transform:translateX(-50%) scale(1.05)}
.locked-badge svg{width:14px;height:14px}

/* Upgrade Modal */
.upgrade-modal{
  position:fixed;inset:0;background:rgba(15,23,42,0.6);backdrop-filter:blur(4px);
  display:flex;align-items:center;justify-content:center;z-index:200;
  opacity:0;pointer-events:none;transition:opacity 0.2s;
}
.upgrade-modal.open{opacity:1;pointer-events:auto}
.upgrade-panel{
  background:var(--white);border-radius:20px;padding:36px;max-width:440px;width:calc(100vw - 32px);
  box-shadow:0 20px 60px rgba(0,0,0,0.3);transform:translateY(20px);transition:transform 0.3s;
}
.upgrade-modal.open .upgrade-panel{transform:translateY(0)}
html.dark .upgrade-panel{background:#1E1A2B;border:1px solid var(--slate-700)}
.upgrade-panel h2{font-size:1.3rem;margin-bottom:4px}
.upgrade-panel .price{font-size:2rem;font-weight:800;background:linear-gradient(135deg,#5E6AD2,#8B5CF6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin:16px 0 4px}
.upgrade-panel .price-note{font-size:.72rem;color:var(--slate-400);margin-bottom:20px}
.upgrade-features{list-style:none;margin-bottom:24px}
.upgrade-features li{padding:6px 0;font-size:.85rem;display:flex;align-items:center;gap:8px;color:var(--slate-500)}
html.dark .upgrade-features li{color:#D5CFE0}
.upgrade-features li::before{content:'✓';color:#5E6AD2;font-weight:700;width:18px;text-align:center}
.key-input{
  width:100%;padding:12px 14px;border:2px solid var(--slate-200);border-radius:10px;
  font-family:'Cascadia Code','Fira Code',monospace;font-size:.95rem;text-align:center;
  letter-spacing:2px;text-transform:uppercase;background:var(--slate-50);
  transition:border-color 0.2s;
}
html.dark .key-input{background:#14111E;border-color:#4A4260;color:#EAE4F0}
.key-input:focus{border-color:#5E6AD2;outline:none}
.key-input.error{border-color:var(--red);animation:shake 0.4s}
.key-input.success{border-color:#10B981}
@keyframes shake{0%,100%{transform:translateX(0)}20%,60%{transform:translateX(-6px)}40%,80%{transform:translateX(6px)}}
.key-status{font-size:.72rem;margin-top:6px;text-align:center;min-height:1.2em}
.key-status.error{color:var(--red)}
.key-status.success{color:#10B981}
.upgrade-actions{display:flex;gap:8px;margin-top:16px}
.upgrade-actions .btn{flex:1}
.btn-pro{background:linear-gradient(135deg,#5E6AD2,#8B5CF6);color:white;border:none;font-weight:700}
.btn-pro:hover{opacity:0.9}
.buy-links{display:flex;gap:8px;margin-top:12px}
.buy-link{
  flex:1;display:flex;align-items:center;justify-content:center;gap:6px;
  padding:10px;border-radius:10px;font-size:.78rem;font-weight:600;
  text-decoration:none;color:var(--slate);border:1px solid var(--slate-200);
  transition:all 0.2s;
}
html.dark .buy-link{color:#EAE4F0;border-color:#4A4260}
.buy-link:hover{border-color:#5E6AD2;background:rgba(94,106,210,0.05)}
/* ===== FAB (Floating Action Button) ===== */
.fab{
  position:fixed;bottom:28px;right:28px;z-index:30;
  width:56px;height:56px;border-radius:50%;border:none;
  background:linear-gradient(135deg,var(--teal-dark),var(--teal));
  color:white;font-size:1.6rem;cursor:pointer;
  box-shadow:0 4px 14px rgba(20,184,166,0.4);
  display:flex;align-items:center;justify-content:center;
  transition:transform .15s,box-shadow .15s;
  -webkit-tap-highlight-color:transparent;
}
.fab:hover{transform:scale(1.08);box-shadow:0 6px 20px rgba(20,184,166,0.5)}
.fab:active{transform:scale(0.95)}
@media(max-width:768px){.fab{bottom:96px;right:20px;width:56px;height:56px;font-size:1.5rem;border-radius:50%}}
html.dark .fab{box-shadow:0 4px 14px rgba(20,184,166,0.3)}

/* ===== ADD/EDIT TRANSACTION MODAL ===== */
.tx-modal-overlay{
  position:fixed;inset:0;background:rgba(15,23,42,0.4);
  display:none;align-items:flex-end;justify-content:center;z-index:50;
  backdrop-filter:blur(4px);
}
.tx-modal-overlay.open{display:flex}
@media(min-width:769px){.tx-modal-overlay.open{align-items:center}}
.tx-modal{
  background:var(--white);border-radius:20px 20px 0 0;padding:24px;
  width:100%;max-width:480px;max-height:85vh;overflow-y:auto;
  box-shadow:0 -8px 30px rgba(0,0,0,0.15);
}
@media(min-width:769px){.tx-modal{border-radius:16px;box-shadow:0 25px 50px rgba(0,0,0,0.15)}}
html.dark .tx-modal{background:#1E1A2B}
html.dark .tx-modal-overlay{background:rgba(0,0,0,0.6)}
.tx-modal h3{font-size:1.25em;font-weight:700;margin-bottom:16px}
.tx-modal-field{margin-bottom:14px}
.tx-modal-field label{display:block;font-size:.9rem;font-weight:600;color:var(--slate-700);margin-bottom:4px}
html.dark .tx-modal-field label{color:#D5CFE0}
.tx-modal-field input,.tx-modal-field select{
  width:100%;padding:10px 14px;border:1px solid var(--slate-200);border-radius:8px;
  font-size:1rem;font-family:inherit;outline:none;transition:border-color .15s;
  background:var(--white);color:var(--slate);
}
html.dark .tx-modal-field input,html.dark .tx-modal-field select{background:#14111E;border-color:#352F45;color:#EAE4F0}
.tx-modal-field input:focus,.tx-modal-field select:focus{border-color:var(--teal)}
.tx-amount-input{font-size:1.6rem !important;font-weight:700;text-align:center;font-variant-numeric:tabular-nums}
.tx-type-toggle{display:flex;gap:0;border-radius:8px;overflow:hidden;border:1px solid var(--slate-200)}
html.dark .tx-type-toggle{border-color:#352F45}
.tx-type-toggle button{
  flex:1;padding:10px;border:none;font-size:.95rem;font-weight:600;
  cursor:pointer;background:var(--white);color:var(--slate-500);
  font-family:inherit;transition:all .15s;
}
html.dark .tx-type-toggle button{background:#14111E;color:#9B95AD}
.tx-type-toggle button.active-outflow{background:var(--red-light);color:var(--red)}
.tx-type-toggle button.active-inflow{background:var(--teal-light);color:var(--teal-dark)}
html.dark .tx-type-toggle button.active-outflow{background:#7F1D1D;color:#F87171}
html.dark .tx-type-toggle button.active-inflow{background:#1A3B3A;color:#A5B4FC}
.tx-cat-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
@media(max-width:480px){.tx-cat-grid{grid-template-columns:repeat(2,1fr)}}
.tx-cat-btn{
  padding:8px 6px;border:1px solid var(--slate-200);border-radius:8px;
  background:none;cursor:pointer;font-size:.85rem;font-weight:600;
  font-family:inherit;transition:all .15s;text-align:center;
  color:var(--slate-500);
}
html.dark .tx-cat-btn{border-color:#352F45;color:#9B95AD}
.tx-cat-btn.selected{border-width:2px}
.tx-modal-actions{display:flex;gap:8px;margin-top:20px}
.tx-modal-actions .btn{flex:1}
.btn-danger{background:var(--red);color:white;border-color:var(--red)}
.btn-danger:hover{opacity:0.9}

/* Desktop title bar offset */
html.desktop .topbar{-webkit-app-region:drag;padding-right:150px}
html.desktop .topbar *{-webkit-app-region:no-drag}
html.desktop .mobile-header{padding-right:150px}
html.desktop .sidebar{-webkit-app-region:drag}
html.desktop .sidebar *{-webkit-app-region:no-drag}
</style>
<script>if(window.desktop)document.documentElement.classList.add('desktop');</script>
</head>
<body>

<!-- MOBILE HEADER (phone only) -->
<header class="mobile-header">
  <div class="mh-icon">V</div>
  <span class="mh-name">Verso</span>
  <div class="mh-actions">
    <button class="btn btn-primary" id="btnImportMobile" style="padding:6px 12px;font-size:.75rem">Import</button>
    <button class="btn" id="btnDarkMobile" style="padding:6px 10px;font-size:.72rem" title="Dark mode">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M21 12.79A9 9 0 1111.21 3a7 7 0 009.79 9.79z"/></svg>
    </button>
    <div class="overflow-menu-wrap">
      <button class="overflow-btn" id="mobileOverflowBtn" aria-label="More options" title="More options">&#9776;</button>
      <div class="overflow-dropdown" id="mobileOverflowMenu">
        <button id="btnPasteMobile">&#128203; Paste Transactions</button>
        <button id="btnDemoMobile">&#9654; Load Demo Data</button>
        <button id="btnExportMobile">&#128229; Export Data</button>
        <div class="overflow-divider"></div>
        <button id="btnClearMobile" class="danger-item">&#128465; Clear All Data</button>
      </div>
    </div>
  </div>
</header>

<!-- SIDEBAR -->
<nav class="sidebar" aria-label="Main navigation">
  <div class="logo">
    <div class="logo-icon">V</div>
    <span class="logo-text">Verso</span>
    <span class="logo-badge" id="logoBadge">LOCAL</span>
  </div>
  <div id="proSidebarBadge"></div>
  <div class="nav">
    <button class="nav-item active" data-view="dashboard">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      Dashboard
    </button>
    <button class="nav-item" data-view="transactions">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
      Transactions
    </button>
    <button class="nav-item" data-view="budgets">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
      Budgets
    </button>
    <button class="nav-item" data-view="goals">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
      Savings Goals
    </button>
    <div class="nav-divider"></div>
    <button class="nav-item" id="navImport">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      Import CSV/OFX
    </button>
    <button class="nav-item" id="navPaste">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2"/><rect x="8" y="2" width="8" height="4" rx="1"/></svg>
      Paste Transactions
    </button>
    <button class="nav-item" id="navExport">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      Export Data
    </button>
    <div class="nav-divider"></div>
    <button class="nav-item" data-view="sync">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0115-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 01-15 6.7L3 16"/></svg>
      Encrypted Sync
    </button>
  </div>
  <div class="sidebar-footer">
    <div class="privacy-badge">
      <span class="privacy-dot"></span>
      100% local — your data never leaves this device
    </div>
    <button class="purge-btn" id="btnPurge">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
      Purge All Data
    </button>
  </div>
</nav>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <h2 id="viewTitle">Dashboard</h2>
    <div class="topbar-actions">
      <button class="btn" id="btnDarkToggle" title="Toggle dark mode (Ctrl+D)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M21 12.79A9 9 0 1111.21 3a7 7 0 009.79 9.79z"/></svg>
      </button>
      <button class="btn" id="btnKbHelp" title="Keyboard shortcuts (?)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><rect x="2" y="6" width="20" height="12" rx="2"/><line x1="6" y1="10" x2="6" y2="10.01"/><line x1="10" y1="10" x2="10" y2="10.01"/><line x1="14" y1="10" x2="14" y2="10.01"/><line x1="18" y1="10" x2="18" y2="10.01"/><line x1="8" y1="14" x2="16" y2="14"/></svg>
      </button>
      <button class="btn" id="btnDemo">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polygon points="5 3 19 12 5 21 5 3"/></svg>
        Demo
      </button>
      <button class="btn" id="btnPaste">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2"/><rect x="8" y="2" width="8" height="4" rx="1"/></svg>
        Paste
      </button>
      <button class="btn btn-primary" id="btnImport">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        Import
      </button>
    </div>
  </div>

  <main class="content" id="content" role="main" aria-live="polite">
    <!-- Views rendered by JS -->
  </main>
</div>

<!-- IMPORT MODAL -->
<div class="modal-overlay" id="importModal" role="dialog" aria-label="Import bank statement">
  <div class="modal">
    <h3>Import Bank Statement</h3>
    <p class="subtitle">Drop in a CSV, OFX, or QFX file from any major bank. Format auto-detected. Data stays 100% on-device.</p>
    <details style="margin-bottom:14px">
      <summary style="font-size:.92rem;color:var(--teal-dark);cursor:pointer;font-weight:600;padding:4px 0">Bank CSV Download Guide (21 banks)</summary>
      <div style="max-height:340px;overflow-y:auto;padding:10px 0;font-size:.82rem;color:var(--slate-700);line-height:1.6">
        <div style="background:var(--teal-light);border-radius:8px;padding:8px 12px;margin-bottom:10px;font-size:.75rem">
          <strong>Important:</strong> No bank offers CSV download from their mobile app. You must use the bank's <strong>website</strong> (desktop browser or "Request Desktop Site" on your phone).
        </div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <details style="background:var(--slate-50);border-radius:8px;padding:0">
            <summary style="padding:10px 12px;cursor:pointer;font-weight:700;color:#005EB8;font-size:.88rem">Chase <span style="font-size:.75rem;color:var(--slate-400);font-weight:400">· chase.com · Up to 24 months</span></summary>
            <div style="padding:4px 12px 12px;font-size:.75rem">
              <ol style="margin:0;padding-left:18px"><li>Sign in at chase.com</li><li>Select your account (checking/savings/credit card)</li><li>Click the <strong>"Download account activity"</strong> icon (↓ arrow near transactions) — or <strong>More → Download account activity</strong></li><li>File type → <strong>"Spreadsheet (Excel, CSV)"</strong></li><li>Set date range → Click <strong>Download</strong></li></ol>
              <div style="margin-top:6px;padding:6px 8px;background:var(--amber-light);border-radius:6px;font-size:.78rem"><strong>Heads up:</strong> ~1,500 transaction cap per download. Mobile app = PDF only.</div>
            </div>
          </details>
          <details style="background:var(--slate-50);border-radius:8px;padding:0">
            <summary style="padding:10px 12px;cursor:pointer;font-weight:700;color:#2A5DB0;font-size:.88rem">Bank of America <span style="font-size:.75rem;color:var(--slate-400);font-weight:400">· bankofamerica.com · 18mo / 12mo CC</span></summary>
            <div style="padding:4px 12px 12px;font-size:.75rem">
              <ol style="margin:0;padding-left:18px"><li>Log in at bankofamerica.com</li><li>Click your account → <strong>Activity</strong> tab</li><li>Click <strong>"Download"</strong> link (right side, above transactions)</li><li>Set date range → Select <strong>"Microsoft Excel Format"</strong> (this IS a CSV despite the name)</li><li>Click <strong>"Download Transactions"</strong></li></ol>
              <div style="margin-top:6px;padding:6px 8px;background:var(--amber-light);border-radius:6px;font-size:.78rem"><strong>Heads up:</strong> 3,000 transaction cap. QFX discontinued. Credit cards limited to 12 months.</div>
            </div>
          </details>
          <details style="background:var(--slate-50);border-radius:8px;padding:0">
            <summary style="padding:10px 12px;cursor:pointer;font-weight:700;color:#D71E28;font-size:.88rem">Wells Fargo <span style="font-size:.75rem;color:var(--slate-400);font-weight:400">· wellsfargo.com · 18mo / 90d CC</span></summary>
            <div style="padding:4px 12px 12px;font-size:.75rem">
              <ol style="margin:0;padding-left:18px"><li>Sign in at wellsfargo.com</li><li>Select account → <strong>Account Activity</strong></li><li>Click <strong>"Download Account Activity"</strong></li><li>Set date range → File Type: <strong>"Comma Delimited (ASCII, Spreadsheet)"</strong></li><li>Click <strong>Download</strong></li></ol>
              <div style="margin-top:6px;padding:6px 8px;background:var(--amber-light);border-radius:6px;font-size:.78rem"><strong>Heads up:</strong> Credit cards limited to just 90 days. Format labeled "Comma Delimited" not "CSV."</div>
            </div>
          </details>
          <details style="background:var(--slate-50);border-radius:8px;padding:0">
            <summary style="padding:10px 12px;cursor:pointer;font-weight:700;color:#1A73B5;font-size:.88rem">Citibank <span style="font-size:.75rem;color:var(--slate-400);font-weight:400">· citi.com · Up to 180 days</span></summary>
            <div style="padding:4px 12px 12px;font-size:.75rem">
              <ol style="margin:0;padding-left:18px"><li>Sign in at citi.com → select account</li><li>Go to <strong>"Your Activity"</strong></li><li>Set date range → Click <strong>Search</strong></li><li>Click the <strong>Download icon</strong> (top-right of transactions)</li><li>Under "Text Formats" select <strong>"CSV"</strong> → <strong>Export</strong></li></ol>
              <div style="margin-top:6px;padding:6px 8px;background:var(--amber-light);border-radius:6px;font-size:.78rem"><strong>Bug:</strong> Format picker breaks with ad blockers. Use <strong>Incognito mode</strong> if dropdown doesn't work.</div>
            </div>
          </details>
          <details style="background:var(--slate-50);border-radius:8px;padding:0">
            <summary style="padding:10px 12px;cursor:pointer;font-weight:700;color:#0A6EAD;font-size:.88rem">Capital One <span style="font-size:.75rem;color:var(--slate-400);font-weight:400">· capitalone.com · ~2yr / 25mo CC</span></summary>
            <div style="padding:4px 12px 12px;font-size:.75rem">
              <ol style="margin:0;padding-left:18px"><li>Log in at capitalone.com</li><li>Click your account</li><li>Find <strong>"Download Transactions"</strong> — may be under gear icon <strong>"I want to..."</strong></li><li>File Type → <strong>CSV</strong> → set time period</li><li>Click <strong>Export</strong></li></ol>
              <div style="margin-top:6px;padding:6px 8px;background:var(--amber-light);border-radius:6px;font-size:.78rem"><strong>Note:</strong> Checking/savings ~90 days per download. Credit cards up to 25 months.</div>
            </div>
          </details>
          <details style="background:var(--slate-50);border-radius:8px;padding:0">
            <summary style="padding:10px 12px;cursor:pointer;font-weight:700;color:#D8273F;font-size:.88rem">US Bank <span style="font-size:.75rem;color:var(--slate-400);font-weight:400">· usbank.com · 18mo (90-day chunks)</span></summary>
            <div style="padding:4px 12px 12px;font-size:.75rem">
              <ol style="margin:0;padding-left:18px"><li>Log in at usbank.com</li><li><strong>My Accounts</strong> → select account</li><li>Find the <strong>download icon</strong> (↓) in the Transactions tile top-right</li><li>Set date range → choose <strong>CSV</strong></li><li>Click <strong>Download</strong></li></ol>
              <div style="margin-top:6px;padding:6px 8px;background:var(--amber-light);border-radius:6px;font-size:.78rem"><strong>Painful:</strong> Only 90 days per download. For 18 months, you need 6 separate downloads.</div>
            </div>
          </details>
          <details style="background:var(--slate-50);border-radius:8px;padding:0">
            <summary style="padding:10px 12px;cursor:pointer;font-weight:700;color:#F58220;font-size:.88rem">PNC Bank <span style="font-size:.75rem;color:var(--slate-400);font-weight:400">· pnc.com · 90d CSV / 2yr QFX</span></summary>
            <div style="padding:4px 12px 12px;font-size:.75rem">
              <ol style="margin:0;padding-left:18px"><li>Log in at pnc.com</li><li><strong>My Accounts</strong> → select account → <strong>Account Activity</strong></li><li>Change date to <strong>"Custom Date Range"</strong></li><li>Click <strong>Export</strong></li></ol>
              <div style="margin-top:6px;padding:6px 8px;background:var(--amber-light);border-radius:6px;font-size:.78rem"><strong>Warning:</strong> CSV limited to 90 days. For older data: Online Statements → Activity Detail → Export (one month at a time). Virtual Wallet may be PDF-only.</div>
            </div>
          </details>
          <details style="background:var(--slate-50);border-radius:8px;padding:0">
            <summary style="padding:10px 12px;cursor:pointer;font-weight:700;color:#54B948;font-size:.88rem">TD Bank <span style="font-size:.75rem;color:var(--slate-400);font-weight:400">· tdbank.com · 45-day batches</span></summary>
            <div style="padding:4px 12px 12px;font-size:.75rem">
              <ol style="margin:0;padding-left:18px"><li>Log in at tdbank.com</li><li><strong>My Accounts</strong> → click account → <strong>Activity</strong> tab</li><li>Scroll to the <strong>bottom</strong> of the page</li><li>Select <strong>"Spreadsheet (.CSV)"</strong> from dropdown next to Download</li><li>Click <strong>Download</strong></li></ol>
              <div style="margin-top:6px;padding:6px 8px;background:var(--amber-light);border-radius:6px;font-size:.78rem"><strong>Heads up:</strong> 45-day cap per download. Download button is at the BOTTOM of the page.</div>
            </div>
          </details>
          <details style="background:var(--slate-50);border-radius:8px;padding:0">
            <summary style="padding:10px 12px;cursor:pointer;font-weight:700;color:#6B2D8B;font-size:.88rem">Truist <span style="font-size:.75rem;color:var(--slate-400);font-weight:400">· truist.com · Up to 18 months</span></summary>
            <div style="padding:4px 12px 12px;font-size:.75rem">
              <ol style="margin:0;padding-left:18px"><li>Sign in at truist.com</li><li>Click your account</li><li>Click the <strong>Download</strong> button near transactions</li><li>Set date range (30d, 60d, or custom)</li><li>File type <strong>defaults to CSV</strong> — click Download</li></ol>
              <div style="margin-top:6px;padding:6px 8px;background:var(--amber-light);border-radius:6px;font-size:.78rem"><strong>Note:</strong> CSV column layout changed late 2025. Columns: Posted Date, Transaction Date, Description, Merchant, Category, Amount.</div>
            </div>
          </details>
          <details style="background:var(--slate-50);border-radius:8px;padding:0">
            <summary style="padding:10px 12px;cursor:pointer;font-weight:700;color:#7B2D72;font-size:.88rem">Ally Bank <span style="font-size:.75rem;color:var(--slate-400);font-weight:400">· ally.com · Up to 18 months</span></summary>
            <div style="padding:4px 12px 12px;font-size:.75rem">
              <ol style="margin:0;padding-left:18px"><li>Log in at ally.com</li><li>Select your account</li><li>Scroll to <strong>"Transaction History"</strong></li><li>Click the <strong>download icon</strong> (↓ arrow — easy to miss)</li><li>Set date range → choose <strong>CSV</strong> → Download</li></ol>
              <div style="margin-top:6px;padding:6px 8px;background:var(--amber-light);border-radius:6px;font-size:.78rem"><strong>Note:</strong> Download icon is small and embedded in the Transaction History section. Only works for checking/savings — not investment accounts.</div>
            </div>
          </details>
          <details style="background:var(--slate-50);border-radius:8px;padding:0">
            <summary style="padding:10px 12px;cursor:pointer;font-weight:700;color:#FF6600;font-size:.88rem">Discover <span style="font-size:.75rem;color:var(--slate-400);font-weight:400">· discover.com · Up to 24 months</span></summary>
            <div style="padding:4px 12px 12px;font-size:.75rem">
              <ol style="margin:0;padding-left:18px"><li>Log in at discover.com</li><li>Click <strong>"Activity"</strong> → <strong>"Search Transactions"</strong></li><li>Enter date range → <strong>Search</strong></li><li>Click <strong>Download</strong> (top-right of results)</li><li>Select <strong>CSV</strong> → Download</li></ol>
            </div>
          </details>
          <details style="background:var(--slate-50);border-radius:8px;padding:0">
            <summary style="padding:10px 12px;cursor:pointer;font-weight:700;color:#3A6DB8;font-size:.88rem">USAA <span style="font-size:.75rem;color:var(--slate-400);font-weight:400">· usaa.com · 45d checking / 90d CC</span></summary>
            <div style="padding:4px 12px 12px;font-size:.75rem">
              <ol style="margin:0;padding-left:18px"><li>Log in at usaa.com</li><li><strong>My Accounts</strong> → select account</li><li>Click <strong>"I Want To..."</strong> → <strong>"Export"</strong></li><li>Set date range → <strong>"Comma-Delimited (CSV)"</strong></li><li>Click <strong>Export</strong></li></ol>
              <div style="margin-top:6px;padding:6px 8px;background:var(--red-light);border-radius:6px;font-size:.78rem"><strong>Critical bug:</strong> Credit card CSV has debit/credit signs FLIPPED. You may need to reverse the amounts after import. Only 45 days for checking.</div>
            </div>
          </details>
          <details style="background:var(--slate-50);border-radius:8px;padding:0">
            <summary style="padding:10px 12px;cursor:pointer;font-weight:700;color:#2B6FAE;font-size:.88rem">Navy Federal <span style="font-size:.75rem;color:var(--slate-400);font-weight:400">· navyfederal.org</span></summary>
            <div style="padding:4px 12px 12px;font-size:.75rem">
              <ol style="margin:0;padding-left:18px"><li>Log in at navyfederal.org</li><li>Select account → transaction history</li><li>Click <strong>Download/Export</strong></li><li>Select <strong>CSV</strong> → set date range → Download</li></ol>
              <div style="margin-top:6px;padding:6px 8px;background:var(--amber-light);border-radius:6px;font-size:.78rem"><strong>Note:</strong> CSV dates may be missing the year column. One account at a time only.</div>
            </div>
          </details>
          <details style="background:var(--slate-50);border-radius:8px;padding:0">
            <summary style="padding:10px 12px;cursor:pointer;font-weight:700;color:#00A0DF;font-size:.88rem">Charles Schwab <span style="font-size:.75rem;color:var(--slate-400);font-weight:400">· schwab.com · Up to 10 years</span></summary>
            <div style="padding:4px 12px 12px;font-size:.75rem">
              <ol style="margin:0;padding-left:18px"><li>Log in at schwab.com</li><li><strong>Accounts</strong> → <strong>History</strong></li><li>Select account and date range → <strong>Search</strong></li><li>Click <strong>Export</strong> (upper right) → <strong>CSV</strong> → Export</li></ol>
              <div style="margin-top:6px;padding:6px 8px;background:var(--red-light);border-radius:6px;font-size:.78rem"><strong>Silent failure:</strong> Over 10,000 transactions = empty file with NO error. Use quarterly date ranges for large accounts.</div>
            </div>
          </details>
          <details style="background:var(--slate-50);border-radius:8px;padding:0">
            <summary style="padding:10px 12px;cursor:pointer;font-weight:700;color:#84BD00;font-size:.88rem">Regions Bank <span style="font-size:.75rem;color:var(--slate-400);font-weight:400">· regions.com · Up to 18 months</span></summary>
            <div style="padding:4px 12px 12px;font-size:.75rem">
              <ol style="margin:0;padding-left:18px"><li>Log in at regions.com → select account</li><li>Click the <strong>"Download Transactions"</strong> icon (small, above pending activity)</li><li>Select <strong>CSV</strong> → set date range → Download</li></ol>
            </div>
          </details>
          <details style="background:var(--slate-50);border-radius:8px;padding:0">
            <summary style="padding:10px 12px;cursor:pointer;font-weight:700;color:#00A86B;font-size:.88rem">Citizens Bank <span style="font-size:.75rem;color:var(--slate-400);font-weight:400">· citizensbank.com · Up to 18 months</span></summary>
            <div style="padding:4px 12px 12px;font-size:.75rem">
              <ol style="margin:0;padding-left:18px"><li>Log in at citizensbank.com → click account</li><li>Click <strong>"Export"</strong> icon or <strong>"Download Account Data"</strong></li><li>Format → <strong>CSV</strong> → set date range → Download</li></ol>
            </div>
          </details>
          <details style="background:var(--slate-50);border-radius:8px;padding:0">
            <summary style="padding:10px 12px;cursor:pointer;font-weight:700;color:#5BA63C;font-size:.88rem">Huntington <span style="font-size:.75rem;color:var(--slate-400);font-weight:400">· huntington.com · ~2 years</span></summary>
            <div style="padding:4px 12px 12px;font-size:.75rem">
              <ol style="margin:0;padding-left:18px"><li>Log in at huntington.com</li><li><strong>My Accounts</strong> → click account</li><li>Click <strong>"Download Account Transactions"</strong></li><li>Set date range → <strong>CSV</strong> → Download</li></ol>
            </div>
          </details>
          <details style="background:var(--slate-50);border-radius:8px;padding:0">
            <summary style="padding:10px 12px;cursor:pointer;font-weight:700;color:#3568C8;font-size:.88rem">Fifth Third <span style="font-size:.75rem;color:var(--slate-400);font-weight:400">· 53.com · No CSV — use QFX</span></summary>
            <div style="padding:4px 12px 12px;font-size:.75rem">
              <p style="color:#3568C8;font-weight:600;margin-bottom:4px">Fifth Third does not offer CSV.</p>
              <ol style="margin:0;padding-left:18px"><li>Log in → <strong>Services</strong> tab → <strong>"Export Transactions"</strong></li><li>Choose <strong>QFX</strong> or <strong>OFX</strong> format</li><li>Set date range → Download</li><li>Import the QFX/OFX file here (we support it!)</li></ol>
            </div>
          </details>
          <details style="background:var(--slate-50);border-radius:8px;padding:0">
            <summary style="padding:10px 12px;cursor:pointer;font-weight:700;color:#00A67E;font-size:.88rem">M&T Bank <span style="font-size:.75rem;color:var(--slate-400);font-weight:400">· mtb.com · PDF only</span></summary>
            <div style="padding:4px 12px 12px;font-size:.75rem">
              <p style="color:#00A67E;font-weight:600;margin-bottom:4px">M&T has no file export at all — only PDF statements.</p>
              <p>Use the <strong>"Paste Transactions"</strong> feature instead: copy transaction text from the M&T website and paste it into our parser.</p>
            </div>
          </details>
          <details style="background:var(--slate-50);border-radius:8px;padding:0">
            <summary style="padding:10px 12px;cursor:pointer;font-weight:700;color:#B31F29;font-size:.88rem">First Hawaiian Bank <span style="font-size:.75rem;color:var(--slate-400);font-weight:400">· fhb.com · No CSV — use QFX/QBO · Up to 36 months</span></summary>
            <div style="padding:4px 12px 12px;font-size:.75rem">
              <p style="color:#B31F29;font-weight:600;margin-bottom:4px">First Hawaiian does not offer CSV export.</p>
              <ol style="margin:0;padding-left:18px"><li>Log in at <strong>fhb.com</strong> → select your account</li><li>Go to the <strong>Transactions</strong> tab</li><li>Click the <strong>"Export"</strong> icon (↓) — or use <strong>Download</strong> link under Accounts tab</li><li>Choose <strong>"Intuit Quicken (.QFX)"</strong> or <strong>"QuickBooks (.QBO)"</strong></li><li>Set date range → Download</li><li>Import the QFX/QBO file here (we support it!)</li></ol>
              <div style="margin-top:6px;padding:6px 8px;background:var(--amber-light);border-radius:6px;font-size:.78rem"><strong>Heads up:</strong> Mobile app may not offer export. Use the website for downloads.</div>
            </div>
          </details>
        </div>
        <div style="margin-top:12px;padding:8px 12px;background:var(--slate-50);border-radius:8px;font-size:.78rem;color:var(--slate-400)">
          <strong>Don't see your bank?</strong> Most banks: Log in on their website → find your account → look for "Download", "Export", or a ↓ icon → choose CSV → pick a date range. We also accept OFX and QFX files.
        </div>
      </div>
    </details>
    <div class="drop-zone" id="dropZone">
      <div class="icon">📂</div>
      <p>Drag & drop your CSV, OFX, or QFX file here, or <strong>click to browse</strong></p>
      <p style="font-size:.68rem;color:var(--slate-400);margin-top:4px">Auto-detects Chase, BofA, Wells Fargo, Capital One, Citi, Discover, and more</p>
      <input type="file" id="fileInput" accept=".csv,.ofx,.qfx,text/csv,text/comma-separated-values,application/csv,text/plain,*/*" style="display:none">
    </div>
    <div id="importPreview"></div>
    <div class="modal-actions">
      <button class="btn" id="importCancel">Cancel</button>
      <button class="btn btn-primary" id="importConfirm" style="display:none">Import Transactions</button>
    </div>
  </div>
</div>

<!-- PASTE TRANSACTIONS MODAL -->
<div class="modal-overlay" id="pasteModal" role="dialog" aria-label="Paste transactions">
  <div class="modal">
    <h3>Paste Transactions</h3>
    <p class="subtitle">Copy transaction text from your banking app or website and paste it below. We'll parse dates, amounts, and categories automatically.</p>
    <textarea class="paste-textarea" id="pasteTextarea" placeholder="Paste your bank transactions here...

Example formats:
02/15/2026  Amazon Purchase  -$47.99
2026-02-14  Direct Deposit   $3,200.00
Feb 12      Starbucks Coffee ($5.75)
01/10/26    Netflix          $15.99"></textarea>
    <div id="pasteStats"></div>
    <div id="pastePreview"></div>
    <div class="modal-actions">
      <button class="btn" id="pasteCancel">Cancel</button>
      <button class="btn btn-primary" id="pasteParse" style="display:inline-flex">Parse</button>
      <button class="btn btn-primary" id="pasteImport" style="display:none">Import All</button>
    </div>
  </div>
</div>

<!-- BUDGET EDIT MODAL -->
<div class="modal-overlay" id="budgetModal">
  <div class="modal" style="width:400px">
    <h3 id="budgetModalTitle">Set Budget Limit</h3>
    <p class="subtitle">Set a monthly spending cap for this category.</p>
    <div class="goal-form" style="margin-bottom:0">
      <label style="display:block;font-size:.9rem;font-weight:600;color:var(--slate-700);margin-bottom:4px;margin-top:12px">Category</label>
      <select id="budgetCategory" style="padding:8px 12px;border:1px solid var(--slate-200);border-radius:8px;font-size:.95rem;font-family:inherit;width:100%;outline:none">
      </select>
      <label style="display:block;font-size:.9rem;font-weight:600;color:var(--slate-700);margin-bottom:4px;margin-top:12px">Monthly Limit ($)</label>
      <input type="number" id="budgetLimit" placeholder="200" min="1" step="10" style="width:100%;padding:8px 12px;border:1px solid var(--slate-200);border-radius:8px;font-size:.95rem;font-family:inherit;outline:none">
    </div>
    <div class="modal-actions">
      <button class="btn" id="budgetCancel">Cancel</button>
      <button class="btn" id="budgetDelete" style="color:var(--red);display:none">Remove</button>
      <button class="btn btn-primary" id="budgetSave">Save</button>
    </div>
  </div>
</div>

<!-- GOAL MODAL -->
<div class="modal-overlay" id="goalModal">
  <div class="modal" style="width:400px">
    <h3>New Savings Goal</h3>
    <p class="subtitle">Set a target and watch your progress grow!</p>
    <div class="goal-form-modal">
      <label>What are you saving for?</label>
      <input type="text" id="goalName" placeholder="e.g. Emergency Fund, Vacation, New Laptop">
      <label>Pick an emoji</label>
      <select id="goalEmoji">
        <option value="&#127919;">&#127919; Target</option><option value="&#127958;&#65039;">&#127958;&#65039; Vacation</option>
        <option value="&#128663;">&#128663; Car</option><option value="&#128187;">&#128187; Tech</option>
        <option value="&#127968;">&#127968; Home</option><option value="&#127891;">&#127891; Education</option>
        <option value="&#128141;">&#128141; Wedding</option><option value="&#128737;&#65039;">&#128737;&#65039; Emergency</option>
        <option value="&#127873;">&#127873; Gift</option><option value="&#9992;&#65039;">&#9992;&#65039; Travel</option>
      </select>
      <label>Target amount ($)</label>
      <input type="number" id="goalTarget" placeholder="1000" min="1">
      <label>Saved so far ($)</label>
      <input type="number" id="goalSaved" placeholder="0" min="0" value="0">
      <label>Target date (optional)</label>
      <input type="date" id="goalDate">
    </div>
    <div class="modal-actions">
      <button class="btn" id="goalCancel">Cancel</button>
      <button class="btn btn-primary" id="goalSave">Save Goal</button>
    </div>
  </div>
</div>

<!-- RECEIPT LIGHTBOX -->
<div id="receiptLightbox" style="display:none"></div>

<!-- BOTTOM NAV (phone only) -->
<nav class="bottom-nav" aria-label="Quick navigation">
  <div class="bottom-nav-items">
    <button class="bottom-nav-item active" data-view="dashboard">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      Home
    </button>
    <button class="bottom-nav-item" data-view="transactions">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
      Activity
    </button>
    <button class="bottom-nav-item" data-view="budgets">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
      Budgets
    </button>
    <button class="bottom-nav-item" data-view="goals">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
      Goals
    </button>
    <button class="bottom-nav-item" data-view="sync">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0115-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 01-15 6.7L3 16"/></svg>
      Sync
    </button>
  </div>
</nav>

<!-- KEYBOARD SHORTCUTS HELP -->
<div class="kb-help" id="kbHelp">
  <div class="kb-panel">
    <h3 style="margin-bottom:16px;font-size:1em">Keyboard Shortcuts</h3>
    <div class="kb-row"><span class="kb-desc">Dashboard</span><span class="kb-key">D</span></div>
    <div class="kb-row"><span class="kb-desc">Transactions</span><span class="kb-key">T</span></div>
    <div class="kb-row"><span class="kb-desc">Budgets</span><span class="kb-key">B</span></div>
    <div class="kb-row"><span class="kb-desc">Savings Goals</span><span class="kb-key">G</span></div>
    <div class="kb-row"><span class="kb-desc">Encrypted Sync</span><span class="kb-key">S</span></div>
    <div class="kb-row"><span class="kb-desc">Import CSV/OFX</span><span class="kb-key">I</span></div>
    <div class="kb-row"><span class="kb-desc">Paste Transactions</span><span class="kb-key">P</span></div>
    <div class="kb-row"><span class="kb-desc">Export Data</span><span class="kb-key">E</span></div>
    <div class="kb-row"><span class="kb-desc">Toggle Dark Mode</span><span class="kb-key">Ctrl+D</span></div>
    <div class="kb-row"><span class="kb-desc">Show Shortcuts</span><span class="kb-key">?</span></div>
    <div class="kb-row"><span class="kb-desc">Close / Dismiss</span><span class="kb-key">Esc</span></div>
    <div style="margin-top:12px;text-align:right">
      <button class="btn" onclick="document.getElementById('kbHelp').classList.remove('open')">Close</button>
    </div>
  </div>
</div>

<!-- PURGE CONFIRMATION -->
<div class="modal-overlay" id="purgeModal">
  <div class="modal" style="width:400px;text-align:center">
    <div style="font-size:2.5em;margin-bottom:8px">&#9888;&#65039;</div>
    <h3 style="color:var(--red)">Purge All Data</h3>
    <p class="subtitle" style="margin-bottom:16px">This permanently deletes all transactions, budgets, and goals from this device. This action cannot be undone.</p>
    <div style="display:flex;gap:8px;justify-content:center">
      <button class="btn" id="purgeCancel">Cancel</button>
      <button class="btn" id="purgeConfirm" style="background:var(--red);color:white;border-color:var(--red)">Purge Everything</button>
    </div>
  </div>
</div>

<!-- PRO UPGRADE MODAL -->
<div class="upgrade-modal" id="upgradeModal">
  <div class="upgrade-panel">
    <div style="text-align:center">
      <div style="font-size:2em;margin-bottom:4px">&#9889;</div>
      <h2>Verso Pro</h2>
      <div class="price">$6.99</div>
      <div class="price-note">One-time purchase. No subscription. No cloud.</div>
    </div>
    <ul class="upgrade-features">
      <li>Advanced keyboard shortcuts</li>
      <li>Spending velocity gauge</li>
      <li>6-month trend analytics</li>
      <li>Advanced analytics & insights</li>
      <li>Encrypted device-to-device sync</li>
      <li>Data purge tool</li>
      <li>Budget category limits</li>
      <li>Receipt photo capture</li>
      <li>All future updates included</li>
    </ul>
    <input type="text" class="key-input" id="proKeyInput" placeholder="VERSO-XXXX-XXXX-XXXX" maxlength="20" autocomplete="off" spellcheck="false">
    <div class="key-status" id="proKeyStatus"></div>
    <div class="upgrade-actions">
      <button class="btn" id="upgradeCancel">Later</button>
      <button class="btn btn-pro" id="upgradeActivate">Activate Key</button>
    </div>
    <div class="buy-links">
      <a class="buy-link" href="#" id="buyGoogle">
        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M3 20.5v-17c0-.83.52-1.28 1.02-1.42L12 8l-8 4.5v8l-1-.5zm1-4l7-4-7-4v8zm9 0l8-4.5L13 8V3.5l8 8.5-8 8.5V16.5z"/></svg>
        Google Play
      </a>
      <a class="buy-link" href="#" id="buyDirect">
        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2"/><path d="M2 10h20"/></svg>
        Buy Direct
      </a>
    </div>
  </div>
</div>

<!-- FAB -->
<button class="fab" id="fabAdd" title="Add Transaction" aria-label="Add Transaction">+</button>

<!-- ADD/EDIT TRANSACTION MODAL -->
<div class="tx-modal-overlay" id="txModal">
  <div class="tx-modal">
    <h3 id="txModalTitle">Add Transaction</h3>
    <div class="tx-modal-field">
      <label>Amount</label>
      <input type="number" id="txAmount" class="tx-amount-input" placeholder="0.00" min="0" step="0.01" inputmode="decimal">
    </div>
    <div class="tx-modal-field">
      <label>Type</label>
      <div class="tx-type-toggle" id="txTypeToggle">
        <button type="button" data-type="outflow" class="active-outflow">Outflow</button>
        <button type="button" data-type="inflow">Inflow</button>
      </div>
    </div>
    <div class="tx-modal-field">
      <label>Description</label>
      <input type="text" id="txDesc" placeholder="e.g. AWS Cloud Services">
    </div>
    <div class="tx-modal-field">
      <label>Category</label>
      <div class="tx-cat-grid" id="txCatGrid"></div>
    </div>
    <div class="tx-modal-field">
      <label>Date</label>
      <input type="date" id="txDate">
    </div>
    <div id="txReceiptRow" style="margin-top:12px;display:none">
      <label style="display:block;font-size:.9rem;font-weight:600;color:var(--slate-700);margin-bottom:4px">Receipt Photo</label>
      <label class="receipt-btn" style="display:inline-flex;padding:10px 16px;font-size:.9rem;gap:8px" id="txReceiptLabel">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>
        Attach Receipt Photo
        <input type="file" accept="image/*" capture="environment" style="display:none" id="txReceiptInput">
      </label>
      <div id="txReceiptPreview" style="margin-top:8px"></div>
    </div>
    <div class="tx-modal-actions" id="txModalActions">
      <button class="btn" id="txCancel">Cancel</button>
      <button class="btn btn-primary" id="txSave">Save</button>
    </div>
  </div>
</div>

<div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
// ================================================================
// VERSO — The Other Side of Your Finances
// All data stays in IndexedDB. Nothing leaves this device.
// ================================================================

// ===== PRO SYSTEM =====
let isPro = localStorage.getItem('verso_pro') === '1';
if (!isPro) { localStorage.setItem('verso_pro', '1'); isPro = true; }

function validateKey(key) {
  const clean = key.toUpperCase().replace(/^VERSO-/, '').replace(/-/g, '');
  if (clean.length !== 12 || !/^[A-Z0-9]+$/.test(clean)) return false;
  const payload = clean.slice(0, 10);
  const check = clean.slice(10, 12);
  let h = 7919;
  for (let i = 0; i < payload.length; i++) h = ((h << 5) - h + payload.charCodeAt(i) * 31) & 0x7FFFFFFF;
  return check === String.fromCharCode(65 + (h % 26)) + String.fromCharCode(65 + ((h >> 5) % 26));
}

function activatePro() {
  isPro = true;
  localStorage.setItem('verso_pro', '1');
  document.getElementById('upgradeModal').classList.remove('open');
  updateProUI();
  toast('Pro activated! All your data is right where you left it.');
  render();
}

function updateProUI() {
  const badge = document.getElementById('logoBadge');
  const sidebar = document.getElementById('proSidebarBadge');
  if (isPro) {
    badge.textContent = 'PRO';
    badge.style.background = 'linear-gradient(135deg,#5E6AD2,#8B5CF6)';
    badge.style.color = 'white';
    sidebar.innerHTML = '';
  } else {
    sidebar.innerHTML = `
      <div class="upgrade-cta" onclick="showUpgrade()" style="margin:0 12px 8px">
        <div class="icon">&#9889;</div>
        <div class="text">
          <div class="title">Upgrade to Pro</div>
          <div class="desc">Unlock analytics, shortcuts & more</div>
        </div>
        <div class="arrow">&#8250;</div>
      </div>`;
  }
}

function showUpgrade() {
  document.getElementById('upgradeModal').classList.add('open');
  document.getElementById('proKeyInput').value = '';
  document.getElementById('proKeyStatus').textContent = '';
  document.getElementById('proKeyInput').classList.remove('error', 'success');
  // Show data reassurance
  const n = transactions.length;
  const note = document.querySelector('.price-note');
  if (note && n > 0) note.textContent = `Your ${n} transaction${n===1?'':'s'} stay exactly as they are. No data lost.`;
  else if (note) note.textContent = 'One-time purchase. No subscription. No cloud.';
}

function requirePro(featureName) {
  if (isPro) return true;
  showUpgrade();
  return false;
}

function proLockedHTML(featureName) {
  if (isPro) return '';
  return `<div class="locked-badge" onclick="showUpgrade()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
    Unlock with Pro
  </div>`;
}

// Pro modal events
document.getElementById('upgradeCancel').addEventListener('click', () => {
  document.getElementById('upgradeModal').classList.remove('open');
});
document.getElementById('upgradeModal').addEventListener('click', e => {
  if (e.target.id === 'upgradeModal') document.getElementById('upgradeModal').classList.remove('open');
});
document.getElementById('upgradeActivate').addEventListener('click', () => {
  const input = document.getElementById('proKeyInput');
  const status = document.getElementById('proKeyStatus');
  const key = input.value.trim();
  if (!key) { status.textContent = 'Enter your license key'; status.className = 'key-status error'; input.classList.add('error'); return; }
  if (validateKey(key)) {
    input.classList.remove('error');
    input.classList.add('success');
    status.textContent = 'Key valid! Activating...';
    status.className = 'key-status success';
    setTimeout(() => {
      document.getElementById('upgradeModal').classList.remove('open');
      activatePro();
    }, 600);
  } else {
    input.classList.add('error');
    input.classList.remove('success');
    status.textContent = 'Invalid key. Check your email for the correct key.';
    status.className = 'key-status error';
  }
});
// Format key input with dashes
document.getElementById('proKeyInput').addEventListener('input', function() {
  let v = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
  if (v.length > 5 && !v.startsWith('VERSO')) v = v;
  // Auto-format: VERSO-XXXX-XXXX-XXXX
  if (v.startsWith('VERSO')) {
    const rest = v.slice(5);
    const parts = rest.match(/.{1,4}/g) || [];
    this.value = 'VERSO' + (parts.length ? '-' + parts.join('-') : '');
  } else {
    const parts = v.match(/.{1,4}/g) || [];
    this.value = parts.join('-');
  }
});

// ===== CATEGORIES =====
const CATEGORIES = {
  groceries:    { name:'Groceries',      color:'#10B981', bg:'#D1FAE5', darkColor:'#34D399', darkBg:'#064E3B' },
  dining:       { name:'Dining Out',     color:'#F59E0B', bg:'#FEF3C7', darkColor:'#FBBF24', darkBg:'#5C3A1A' },
  transport:    { name:'Transport',      color:'#3B82F6', bg:'#DBEAFE', darkColor:'#60A5FA', darkBg:'#1E2D4F' },
  shopping:     { name:'Shopping',       color:'#8B5CF6', bg:'#EDE9FE', darkColor:'#A78BFA', darkBg:'#2E1065' },
  bills:        { name:'Bills & Utils',  color:'#EF4444', bg:'#FEE2E2', darkColor:'#F87171', darkBg:'#7F1D1D' },
  subscriptions:{ name:'Subscriptions',  color:'#EC4899', bg:'#FCE7F3', darkColor:'#F472B6', darkBg:'#831843' },
  health:       { name:'Health',         color:'#14B8A6', bg:'#CCFBF1', darkColor:'#2DD4BF', darkBg:'#1A3B3A' },
  entertainment:{ name:'Entertainment',  color:'#F97316', bg:'#FFEDD5', darkColor:'#FB923C', darkBg:'#7C2D12' },
  income:       { name:'Income',         color:'#059669', bg:'#D1FAE5', darkColor:'#34D399', darkBg:'#064E3B' },
  transfer:     { name:'Transfer',       color:'#64748B', bg:'#F1F5F9', darkColor:'#94A3B8', darkBg:'#352F45' },
  other:        { name:'Other',          color:'#94A3B8', bg:'#F1F5F9', darkColor:'#CBD5E1', darkBg:'#352F45' },
};
const isDarkMode = () => document.documentElement.classList.contains('dark');
const catColor = (cat) => { const c = CATEGORIES[cat]; return c ? (isDarkMode() ? c.darkColor : c.color) : '#94A3B8'; };
const catBg = (cat) => { const c = CATEGORIES[cat]; return c ? (isDarkMode() ? c.darkBg : c.bg) : '#F1F5F9'; };

const CAT_RULES = [
  [/walmart|target|costco|kroger|safeway|trader.?joe|whole.?foods|aldi|publix|heb|grocery|supermarket/i, 'groceries'],
  [/starbucks|mcdonald|chipotle|subway|doordash|uber.?eats|grubhub|restaurant|cafe|pizza|burger|taco|sushi|diner|brunch/i, 'dining'],
  [/uber(?!.*eats)|lyft|parking|gas|shell|chevron|exxon|bp|citgo|transit|metro|toll/i, 'transport'],
  [/amazon(?!.*prime)|ebay|etsy|best.?buy|apple.?store|nike|zara|h&m|shein|ikea|home.?depot|lowes/i, 'shopping'],
  [/electric|water|gas.?bill|internet|comcast|verizon|at&t|t-?mobile|sprint|xfinity|utility|rent|mortgage|insurance/i, 'bills'],
  [/netflix|spotify|hulu|disney|hbo|youtube.*prem|apple.*music|amazon.*prime|adobe|github|notion|dropbox|icloud/i, 'subscriptions'],
  [/pharmacy|cvs|walgreens|doctor|hospital|dental|medical|health|clinic|urgent.?care|therapy/i, 'health'],
  [/movie|cinema|concert|ticket|steam|playstation|xbox|nintendo|gym|fitness|spotify/i, 'entertainment'],
  [/payroll|salary|direct.?deposit|venmo.*from|zelle.*from|refund|cashback|dividend|interest.*earned/i, 'income'],
  [/transfer|zelle|venmo|paypal|cash.?app|wire/i, 'transfer'],
];

function categorize(desc) {
  const d = desc.toLowerCase();
  for (const [re, cat] of CAT_RULES) { if (re.test(d)) return cat; }
  return 'other';
}

// ===== DATABASE =====
let db = null;
const DB_NAME = 'verso_db';
const DB_VER = 2;

function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = e => {
      const d = e.target.result;
      if (!d.objectStoreNames.contains('transactions')) {
        const store = d.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
        store.createIndex('date', 'date');
        store.createIndex('category', 'category');
      }
      if (!d.objectStoreNames.contains('budgets')) {
        d.createObjectStore('budgets', { keyPath: 'category' });
      }
      if (!d.objectStoreNames.contains('goals')) {
        d.createObjectStore('goals', { keyPath: 'id', autoIncrement: true });
      }
    };
    req.onsuccess = e => { db = e.target.result; resolve(db); };
    req.onerror = e => reject(e.target.error);
  });
}

function dbAdd(store, items) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(store, 'readwrite');
    const s = tx.objectStore(store);
    items.forEach(item => s.add(item));
    tx.oncomplete = () => resolve();
    tx.onerror = e => reject(e.target.error);
  });
}

function dbGetAll(store) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(store, 'readonly');
    const s = tx.objectStore(store);
    const req = s.getAll();
    req.onsuccess = () => resolve(req.result);
    req.onerror = e => reject(e.target.error);
  });
}

function dbClear(store) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(store, 'readwrite');
    tx.objectStore(store).clear();
    tx.oncomplete = () => resolve();
  });
}

function dbPut(store, item) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(store, 'readwrite');
    tx.objectStore(store).put(item);
    tx.oncomplete = () => resolve();
  });
}

// ===== STATE =====
let transactions = [];
let budgets = {};
let goals = [];
let currentView = 'dashboard';
let searchTerm = '';
let filterCat = '';
function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

// ===== CSV PARSER =====
function parseCSV(text) {
  const lines = text.trim().split(/\r?\n/);
  if (lines.length < 2) return [];
  const header = parseCSVLine(lines[0]).map(h => h.trim().replace(/^"|"$/g, '').toLowerCase());

  // Detect columns — prefer name/desc/merchant over memo (US Bank memo is garbage)
  const dateCol = header.findIndex(h => /date/i.test(h));
  let descCol = header.findIndex(h => /^desc|narr|detail|merchant|payee|^name$/i.test(h));
  if (descCol === -1) descCol = header.findIndex(h => /memo/i.test(h));
  const amtCol = header.findIndex(h => /^amount$/i.test(h));
  const debitCol = header.findIndex(h => /debit|withdrawal|payment/i.test(h));
  const creditCol = header.findIndex(h => /credit|deposit/i.test(h));

  if (dateCol === -1) return [];

  const results = [];
  for (let i = 1; i < lines.length; i++) {
    const cols = parseCSVLine(lines[i]);
    if (cols.length <= Math.max(dateCol, descCol || 0)) continue;

    const dateStr = cols[dateCol]?.trim();
    const desc = cols[descCol >= 0 ? descCol : 1]?.trim() || 'Unknown';
    let amount = 0;

    if (amtCol >= 0) {
      amount = parseFloat(cols[amtCol]?.replace(/[^-\d.]/g, '') || '0');
    } else if (debitCol >= 0 || creditCol >= 0) {
      const debit = parseFloat(cols[debitCol]?.replace(/[^-\d.]/g, '') || '0');
      const credit = parseFloat(cols[creditCol]?.replace(/[^-\d.]/g, '') || '0');
      amount = credit > 0 ? credit : -Math.abs(debit);
    }

    if (!dateStr || isNaN(amount) || amount === 0) continue;

    const date = parseDate(dateStr);
    if (!date) continue;

    results.push({
      date: date,
      description: desc.replace(/^"|"$/g, ''),
      amount: Math.round(amount * 100) / 100,
      category: categorize(desc),
    });
  }
  return results;
}

function parseCSVLine(line) {
  const result = [];
  let current = '';
  let inQuotes = false;
  for (const ch of line) {
    if (ch === '"') { inQuotes = !inQuotes; }
    else if (ch === ',' && !inQuotes) { result.push(current); current = ''; }
    else { current += ch; }
  }
  result.push(current);
  return result;
}

function parseDate(str) {
  const s = str.replace(/^"|"$/g, '').trim();
  // MM/DD/YYYY or MM-DD-YYYY
  let m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
  if (m) return `${m[3]}-${m[1].padStart(2,'0')}-${m[2].padStart(2,'0')}`;
  // YYYY-MM-DD
  m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (m) return s;
  // DD/MM/YYYY (try)
  const d = new Date(s);
  if (!isNaN(d)) return d.toISOString().slice(0, 10);
  return null;
}

// ===== OFX/QFX PARSER =====
function parseOFX(text) {
  const results = [];
  // Match STMTTRN blocks
  const txnBlocks = text.match(/<STMTTRN>[\s\S]*?(<\/STMTTRN>|(?=<STMTTRN>|<\/BANKTRANLIST))/gi) || [];
  for (const block of txnBlocks) {
    const getTag = (tag) => {
      const m = block.match(new RegExp('<' + tag + '>([^<\\r\\n]+)', 'i'));
      return m ? m[1].trim() : '';
    };
    const trnType = getTag('TRNTYPE');
    const dtPosted = getTag('DTPOSTED');
    const trnAmt = getTag('TRNAMT');
    const name = getTag('NAME') || getTag('MEMO') || 'Unknown';
    const memo = getTag('MEMO');

    if (!dtPosted || !trnAmt) continue;

    // Parse date: YYYYMMDD or YYYYMMDDHHMMSS
    const yr = dtPosted.slice(0,4);
    const mo = dtPosted.slice(4,6);
    const dy = dtPosted.slice(6,8);
    const date = `${yr}-${mo}-${dy}`;
    if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) continue;

    let amount = parseFloat(trnAmt);
    if (isNaN(amount)) continue;

    const desc = memo && memo !== name ? `${name} - ${memo}` : name;
    results.push({
      date,
      description: desc,
      amount: Math.round(amount * 100) / 100,
      category: categorize(desc),
    });
  }
  return results;
}

// ===== PASTE TRANSACTION PARSER =====
function parsePastedText(text) {
  const lines = text.trim().split(/\r?\n/);
  const results = [];

  // Date patterns
  const datePatterns = [
    // MM/DD/YYYY or MM-DD-YYYY
    { re: /(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/, fmt: (m) => `${m[3]}-${m[1].padStart(2,'0')}-${m[2].padStart(2,'0')}` },
    // MM/DD/YY or MM-DD-YY
    { re: /(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2})(?!\d)/, fmt: (m) => `20${m[3]}-${m[1].padStart(2,'0')}-${m[2].padStart(2,'0')}` },
    // YYYY-MM-DD
    { re: /(\d{4})-(\d{2})-(\d{2})/, fmt: (m) => `${m[1]}-${m[2]}-${m[3]}` },
    // Mon DD YYYY or Mon DD, YYYY
    { re: /(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+(\d{1,2}),?\s*(\d{4})/i, fmt: (m) => {
      const months = {jan:'01',feb:'02',mar:'03',apr:'04',may:'05',jun:'06',jul:'07',aug:'08',sep:'09',oct:'10',nov:'11',dec:'12'};
      return `${m[3]}-${months[m[1].toLowerCase()]}-${m[2].padStart(2,'0')}`;
    }},
    // DD Mon YYYY
    { re: /(\d{1,2})\s+(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+(\d{4})/i, fmt: (m) => {
      const months = {jan:'01',feb:'02',mar:'03',apr:'04',may:'05',jun:'06',jul:'07',aug:'08',sep:'09',oct:'10',nov:'11',dec:'12'};
      return `${m[3]}-${months[m[2].toLowerCase()]}-${m[1].padStart(2,'0')}`;
    }},
    // Mon DD (assume current year)
    { re: /(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+(\d{1,2})(?!\s*\d)/i, fmt: (m) => {
      const months = {jan:'01',feb:'02',mar:'03',apr:'04',may:'05',jun:'06',jul:'07',aug:'08',sep:'09',oct:'10',nov:'11',dec:'12'};
      return `${new Date().getFullYear()}-${months[m[1].toLowerCase()]}-${m[2].padStart(2,'0')}`;
    }},
  ];

  // Amount patterns
  const amountPatterns = [
    // -$1,234.56 or -$50.00
    { re: /-\$[\d,]+\.?\d*/, parse: (s) => -parseFloat(s.replace(/[$,]/g,'')) },
    // ($50.00) parenthetical negative
    { re: /\([\$]?[\d,]+\.?\d*\)/, parse: (s) => -parseFloat(s.replace(/[()$,]/g,'')) },
    // $1,234.56
    { re: /\$[\d,]+\.?\d*/, parse: (s) => parseFloat(s.replace(/[$,]/g,'')) },
    // plain number with optional negative: -1234.56 or 1234.56 (must have decimal)
    { re: /-?[\d,]+\.\d{2}/, parse: (s) => parseFloat(s.replace(/,/g,'')) },
  ];

  for (const line of lines) {
    if (!line.trim()) continue;
    let date = null, amount = null;

    // Try to find a date
    for (const dp of datePatterns) {
      const m = line.match(dp.re);
      if (m) { date = dp.fmt(m); break; }
    }

    // Try to find an amount
    for (const ap of amountPatterns) {
      const m = line.match(ap.re);
      if (m) { amount = ap.parse(m[0]); break; }
    }

    if (!date || amount === null || isNaN(amount) || amount === 0) continue;

    // Extract description: remove date and amount, take what's left
    let desc = line;
    for (const dp of datePatterns) {
      desc = desc.replace(dp.re, '');
    }
    for (const ap of amountPatterns) {
      desc = desc.replace(ap.re, '');
    }
    desc = desc.replace(/[|,\t]+/g, ' ').replace(/\s+/g, ' ').trim();
    if (!desc) desc = 'Unknown';

    results.push({
      date,
      description: desc,
      amount: Math.round(amount * 100) / 100,
      category: categorize(desc),
    });
  }
  return results;
}

// ===== SMART BANK DETECTION =====
const BANK_SIGNATURES = {
  chase:      { name:'Chase', color:'#117ACA', headers:[/transaction date/i, /post date/i, /description/i], combo:/transaction date.*post date.*description/i },
  bofa:       { name:'Bank of America', color:'#012169', headers:[/date/i, /description/i, /amount/i], combo:/date.*description.*amount/i, hint:/posted date|reference number/i },
  wellsfargo: { name:'Wells Fargo', color:'#C41230', headers:[/date/i, /amount/i], combo:/date.*amount/i, hint:/^\d{1,2}\/\d{1,2}\/\d{4},".*?"/ },
  capitalone: { name:'Capital One', color:'#004977', headers:[/transaction date/i, /posted date/i, /card no/i], combo:/transaction date.*posted date.*card no/i },
  citi:       { name:'Citi', color:'#003B70', headers:[/status/i, /date/i, /description/i, /debit/i, /credit/i], combo:/status.*date.*description.*debit.*credit/i },
  discover:   { name:'Discover', color:'#FF6600', headers:[/trans\. date/i, /post date/i, /description/i, /amount/i, /category/i], combo:/trans.*date.*post date.*description.*amount.*category/i },
  usbank:     { name:'US Bank', color:'#D8273F', headers:[/date/i, /transaction/i, /name/i, /memo/i, /amount/i], combo:/date.*transaction.*name.*memo.*amount/i },
};

function detectBank(headerLine, firstFewLines) {
  const h = headerLine.toLowerCase();
  for (const [key, sig] of Object.entries(BANK_SIGNATURES)) {
    if (sig.combo && sig.combo.test(headerLine)) return { key, ...sig };
    if (sig.hint && firstFewLines && sig.hint.test(firstFewLines)) return { key, ...sig };
  }
  return null;
}

// ===== DEMO DATA =====
function generateDemo() {
  const cats = [
    ['AWS Cloud Services', -342.00, 'bills'], ['Stripe Processing Fees', -89.00, 'bills'],
    ['WeWork Coworking', -399.00, 'bills'], ['Figma Team', -45.00, 'subscriptions'],
    ['Slack Business+', -12.50, 'subscriptions'], ['QuickBooks Subscription', -40.00, 'subscriptions'],
    ['Adobe Creative Cloud', -54.99, 'subscriptions'], ['Google Workspace', -18.00, 'subscriptions'],
    ['GitHub Team', -21.00, 'subscriptions'], ['Notion Business', -15.00, 'subscriptions'],
    ['Zoom Pro', -13.33, 'subscriptions'], ['1Password Business', -7.99, 'subscriptions'],
    ['Office Supplies Amazon', -67.43, 'shopping'], ['UPS Shipping', -34.20, 'transport'],
    ['FedEx Express', -28.90, 'transport'], ['Business Lunch Meeting', -86.50, 'dining'],
    ['Client Dinner', -124.75, 'dining'], ['Team Coffee Run', -32.10, 'dining'],
    ['Uber Business Trip', -42.30, 'transport'], ['Domain Renewal GoDaddy', -19.99, 'bills'],
    ['Cloudflare Pro', -25.00, 'bills'], ['LinkedIn Premium', -59.99, 'subscriptions'],
    ['Legal Consultation', -350.00, 'health'], ['Business Insurance', -275.00, 'bills'],
    ['Contractor Payment', -1200.00, 'transfer'], ['Tax Quarterly Payment', -2800.00, 'transfer'],
  ];

  const incomeEntries = [
    ['Client Invoice #1047', 8500.00], ['Client Invoice #1048', 5200.00],
    ['Consulting Retainer', 3000.00], ['Project Milestone Payment', 4750.00],
    ['Advisory Fee', 1500.00], ['Workshop Revenue', 2200.00],
  ];

  const txns = [];
  const now = new Date();
  for (let m = 0; m < 6; m++) {
    const month = new Date(now.getFullYear(), now.getMonth() - m, 1);
    const daysInMonth = new Date(month.getFullYear(), month.getMonth() + 1, 0).getDate();
    const mStr = `${month.getFullYear()}-${String(month.getMonth()+1).padStart(2,'0')}`;
    // Irregular business income (2-3 per month)
    const incomeCount = 2 + Math.floor(Math.random() * 2);
    for (let i = 0; i < incomeCount; i++) {
      const [desc, amt] = incomeEntries[Math.floor(Math.random() * incomeEntries.length)];
      const day = 3 + Math.floor(Math.random() * (daysInMonth - 5));
      const variance = 0.85 + Math.random() * 0.3;
      txns.push({ date: `${mStr}-${String(day).padStart(2,'0')}`, description: desc, amount: Math.round(amt * variance * 100) / 100, category: 'income' });
    }
    // Business expenses
    const count = 14 + Math.floor(Math.random() * 8);
    for (let i = 0; i < count; i++) {
      const [desc, amt, cat] = cats[Math.floor(Math.random() * cats.length)];
      if (cat === 'transfer') continue;
      const day = 1 + Math.floor(Math.random() * (daysInMonth - 1));
      const variance = 0.8 + Math.random() * 0.4;
      txns.push({
        date: `${mStr}-${String(day).padStart(2,'0')}`,
        description: desc,
        amount: Math.round(amt * variance * 100) / 100,
        category: cat,
      });
    }
    // 1 transfer (contractor/tax)
    txns.push({ date: `${mStr}-05`, description: 'Contractor Payment', amount: -1200, category: 'transfer' });
  }
  return txns;
}

// ===== RENDERING =====
const $ = id => document.getElementById(id);
const fmt = (n) => {
  const abs = Math.abs(n);
  return (n < 0 ? '-' : '') + '$' + abs.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
};

function render() {
  const c = $('content');
  if (currentView === 'dashboard') renderDashboard(c);
  else if (currentView === 'transactions') renderTransactions(c);
  else if (currentView === 'budgets') renderBudgets(c);
  else if (currentView === 'goals') renderGoals(c);
  else if (currentView === 'sync') renderSync(c);
}

function renderDashboard(el) {
  const now = new Date();
  const thisMonth = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  const lastMonth = now.getMonth() === 0
    ? `${now.getFullYear()-1}-12`
    : `${now.getFullYear()}-${String(now.getMonth()).padStart(2,'0')}`;

  const thisMonthTx = transactions.filter(t => t.date.startsWith(thisMonth));
  const lastMonthTx = transactions.filter(t => t.date.startsWith(lastMonth));

  const income = thisMonthTx.filter(t => t.amount > 0).reduce((s,t) => s+t.amount, 0);
  const spending = Math.abs(thisMonthTx.filter(t => t.amount < 0).reduce((s,t) => s+t.amount, 0));
  const lastSpending = Math.abs(lastMonthTx.filter(t => t.amount < 0).reduce((s,t) => s+t.amount, 0));
  const balance = transactions.reduce((s,t) => s+t.amount, 0);
  const savingsRate = income > 0 ? Math.round(((income - spending) / income) * 100) : 0;

  const spendChange = lastSpending > 0 ? Math.round(((spending - lastSpending) / lastSpending) * 100) : 0;

  if (transactions.length === 0) {
    el.innerHTML = `
      <div class="empty-state">
        <div class="icon" style="opacity:0.7">&#128202;</div>
        <h3>Welcome to Verso</h3>
        <p>Private, local-first financial tracking for your business. Your data never leaves this device.</p>
        <div class="empty-cta-grid">
          <button class="empty-cta-btn" onclick="openAddTxModal()">
            <span class="cta-icon">&#43;</span>
            <span class="cta-label">Add Entry</span>
            <span class="cta-sub">Manual transaction</span>
          </button>
          <button class="empty-cta-btn" onclick="$('importModal').classList.add('open')">
            <span class="cta-icon">&#128194;</span>
            <span class="cta-label">Import CSV/OFX</span>
            <span class="cta-sub">Bank statement file</span>
          </button>
          <button class="empty-cta-btn" onclick="openPasteModal()">
            <span class="cta-icon">&#128203;</span>
            <span class="cta-label">Paste from Bank</span>
            <span class="cta-sub">Copy-paste text</span>
          </button>
          <button class="empty-cta-btn" onclick="loadDemo()">
            <span class="cta-icon">&#9654;</span>
            <span class="cta-label">Load Demo Data</span>
            <span class="cta-sub">Sample business data</span>
          </button>
        </div>
        <p style="font-size:.72rem;color:var(--slate-400);margin-top:8px">&#128274; Zero-knowledge &middot; 100% local &middot; No accounts &middot; No cloud</p>
      </div>`;
    return;
  }

  // Category breakdown for this month's spending
  const catData = {};
  thisMonthTx.filter(t => t.amount < 0 && t.category !== 'transfer').forEach(t => {
    catData[t.category] = (catData[t.category] || 0) + Math.abs(t.amount);
  });

  // Spending velocity calculation
  const dayOfMonth = now.getDate();
  const daysInMonth = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();
  const daysLeft = daysInMonth - dayOfMonth;
  const dailyRate = dayOfMonth > 0 ? spending / dayOfMonth : 0;
  const projectedSpend = dailyRate * daysInMonth;
  const projectedVsLast = lastSpending > 0 ? Math.round(((projectedSpend - lastSpending) / lastSpending) * 100) : 0;
  const velPct = Math.min(Math.round((dayOfMonth / daysInMonth) * 100), 100);
  const spendPct = income > 0 ? Math.min(Math.round((spending / income) * 100), 100) : 0;
  const onTrack = spendPct <= velPct + 5;
  const velColor = onTrack ? 'var(--teal)' : (spendPct > velPct + 15 ? 'var(--red)' : 'var(--amber)');
  const velLabel = onTrack ? 'On pace' : (spendPct > velPct + 15 ? 'Over pace' : 'Watch pace');

  el.innerHTML = `
    <div class="metrics">
      <div class="metric-card">
        <div class="metric-label">Net Balance</div>
        <div class="metric-value" style="color:${balance>=0?'var(--teal-dark)':'var(--red)'}">${fmt(balance)}</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Monthly Inflows</div>
        <div class="metric-value">${fmt(income)}</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Monthly Outflows</div>
        <div class="metric-value">${fmt(-spending)}</div>
        <span class="metric-change ${spendChange>0?'down':'up'}">${spendChange>0?'↑':'↓'} ${Math.abs(spendChange)}% vs last month</span>
      </div>
      <div class="metric-card">
        <div class="metric-label">Net Margin</div>
        <div class="metric-value" style="color:${savingsRate>=20?'var(--teal-dark)':'var(--amber)'}">${savingsRate}%</div>
      </div>
    </div>
    ${income > 0 && isPro ? `
    <div class="velocity-card">
      <div class="velocity-gauge">
        <svg viewBox="0 0 48 48" width="48" height="48">
          <circle cx="24" cy="24" r="20" fill="none" stroke="var(--slate-100)" stroke-width="4"/>
          <circle cx="24" cy="24" r="20" fill="none" stroke="${velColor}" stroke-width="4"
            stroke-dasharray="${(spendPct/100)*125.6} 125.6" stroke-linecap="round"
            transform="rotate(-90 24 24)"/>
          <text x="24" y="26" text-anchor="middle" font-size="10" font-weight="700" fill="${velColor}">${spendPct}%</text>
        </svg>
      </div>
      <div class="velocity-text">
        <div class="label">Spend Velocity</div>
        <div class="rate" style="color:${velColor}">${velLabel} &middot; ${fmt(-dailyRate)}/day</div>
        <div class="detail">Projected: ${fmt(-projectedSpend)} by month-end (${projectedVsLast >= 0 ? '+' : ''}${projectedVsLast}% vs last) &middot; ${daysLeft} days left</div>
      </div>
    </div>` : income > 0 && !isPro ? `
    <div class="velocity-card" style="opacity:0.75;cursor:pointer" onclick="showUpgrade()">
      <div class="velocity-gauge" style="filter:blur(2px)">
        <svg viewBox="0 0 48 48" width="48" height="48"><circle cx="24" cy="24" r="20" fill="none" stroke="var(--slate-100)" stroke-width="4"/></svg>
      </div>
      <div class="velocity-text">
        <div class="label">Spend Velocity</div>
        <div class="rate" style="color:var(--indigo)">&#128274; Pro Feature</div>
        <div class="detail" style="color:var(--slate-500)">Track your daily burn rate and projected month-end spending</div>
      </div>
    </div>` : ''}
    ${getBudgetSummaryCard()}
    <div class="charts-row">
      <div class="chart-card">
        <div class="chart-title">Spending by Category</div>
        <canvas class="chart-canvas" id="donutChart" height="220"></canvas>
        <div class="legend" id="donutLegend"></div>
      </div>
      <div class="chart-card${isPro ? '' : ' locked-overlay'}" style="position:relative">
        <div class="chart-title">Monthly Trend (6 months)${isPro ? '' : ' <span class="pro-badge">PRO</span>'}</div>
        <canvas class="chart-canvas" id="trendChart" height="220"></canvas>
        ${proLockedHTML('Trend Analytics')}
      </div>
    </div>
    <div class="table-card">
      <div class="table-header">
        <h3>Activity Log</h3>
        <span class="table-count">${thisMonthTx.length} this month</span>
      </div>
      <table>
        <thead><tr><th>Date</th><th>Description</th><th>Category</th><th style="text-align:right">Amount</th></tr></thead>
        <tbody>${thisMonthTx.sort((a,b)=>b.date.localeCompare(a.date)).slice(0,10).map(t => `
          <tr style="cursor:pointer" onclick="openEditTxModal(${t.id})">
            <td>${formatDisplayDate(t.date)}</td>
            <td>${esc(t.description)}</td>
            <td><span class="cat-badge" style="background:${catBg(t.category)};color:${catColor(t.category)}">${CATEGORIES[t.category]?.name||t.category}</span></td>
            <td style="text-align:right" class="${t.amount>=0?'amount-pos':'amount-neg'}">${fmt(t.amount)}</td>
          </tr>`).join('')}
        </tbody>
      </table>
      ${transactions.length > 0 ? `<button class="view-all-link" onclick="switchView('transactions')">View All ${transactions.length} Entries &rarr;</button>` : ''}
    </div>
    ${!isPro ? getPromoBanner() : ''}`;

  requestAnimationFrame(() => {
    drawDonut(catData);
    drawTrend();
  });
}

function getPromoBanner() {
  const promos = [
    { icon:'⚡', title:'Track your burn rate', desc:'See exactly how fast you\'re spending with the velocity gauge.', cta:'Unlock Pro' },
    { icon:'📈', title:'See 6-month trends', desc:'Spot patterns in your spending with monthly trend analytics.', cta:'Unlock Pro' },
    { icon:'🔒', title:'Sync across devices', desc:'Encrypted device-to-device sync. Zero-knowledge. Your data stays yours.', cta:'Unlock Pro' },
    { icon:'⌨️', title:'Power user shortcuts', desc:'Navigate instantly with keyboard shortcuts. j/k to scroll, 1-4 to switch views.', cta:'Unlock Pro' },
    { icon:'📥', title:'Import bank statements', desc:'Drag & drop your bank CSV. Auto-categorizes with smart detection.', cta:'Unlock Pro' },
    { icon:'✏️', title:'Edit any transaction', desc:'Tap any entry to recategorize, adjust amounts, or update dates. Full control.', cta:'Unlock Pro' },
    { icon:'📋', title:'Paste from your bank', desc:'Copy transaction text from your banking app. We parse dates, amounts, and categories automatically.', cta:'Unlock Pro' },
    { icon:'📊', title:'Category budget limits', desc:'Set spending caps per category. Visual alerts when you\'re approaching the limit.', cta:'Unlock Pro' },
    { icon:'📸', title:'Receipt photo capture', desc:'Attach receipt images to transactions. Stored locally with zero-knowledge encryption.', cta:'Unlock Pro' },
    { icon:'💡', title:'Tip: Track everything', desc:'Even small $3-5 purchases add up. The best budgeters log every transaction.', cta:'Go Pro' },
    { icon:'💡', title:'Tip: Review weekly', desc:'A 5-minute weekly review catches overspending before it becomes a habit.', cta:'Go Pro' },
  ];
  const idx = Math.floor(Date.now() / 86400000) % promos.length;
  const p = promos[idx];
  return `<div class="promo-banner" onclick="showUpgrade()">
    <span class="promo-icon">${p.icon}</span>
    <div class="promo-text">
      <div class="promo-title">${p.title}</div>
      <div class="promo-desc">${p.desc}</div>
    </div>
    <span class="promo-cta">${p.cta}</span>
  </div>`;
}

function renderTransactions(el) {
  let filtered = [...transactions].sort((a,b) => b.date.localeCompare(a.date));
  if (searchTerm) filtered = filtered.filter(t => t.description.toLowerCase().includes(searchTerm.toLowerCase()));
  if (filterCat) filtered = filtered.filter(t => t.category === filterCat);

  el.innerHTML = `
    <div class="table-card">
      <div class="table-header">
        <h3>All Transactions</h3>
        <span class="table-count">${filtered.length} found</span>
        <input type="text" class="table-search" placeholder="Search transactions..." id="txSearch" value="${searchTerm}">
        <select class="table-filter" id="txFilter">
          <option value="">All Categories</option>
          ${Object.entries(CATEGORIES).map(([k,v]) => `<option value="${k}" ${filterCat===k?'selected':''}>${v.name}</option>`).join('')}
        </select>
      </div>
      <table>
        <thead><tr><th>Date</th><th>Description</th><th>Category</th><th style="text-align:right">Amount</th></tr></thead>
        <tbody>${filtered.length === 0 ? '<tr><td colspan="4" style="text-align:center;padding:40px;color:var(--slate-400)">No transactions found</td></tr>' :
          filtered.slice(0, 100).map(t => `
          <tr style="cursor:pointer" onclick="openEditTxModal(${t.id})">
            <td>${formatDisplayDate(t.date)}</td>
            <td>${esc(t.description)}${t.receipt ? ' <span style="opacity:.5" title="Has receipt">📷</span>' : ''}</td>
            <td><span class="cat-badge" style="background:${catBg(t.category)};color:${catColor(t.category)}">${CATEGORIES[t.category]?.name||t.category}</span></td>
            <td style="text-align:right" class="${t.amount>=0?'amount-pos':'amount-neg'}">${fmt(t.amount)}</td>
          </tr>`).join('')}
        </tbody>
      </table>
    </div>`;

  const search = $('txSearch');
  if (search) search.addEventListener('input', e => { searchTerm = e.target.value; renderTransactions(el); });
  const filter = $('txFilter');
  if (filter) filter.addEventListener('change', e => { filterCat = e.target.value; renderTransactions(el); });
}

function renderBudgets(el) {
  const FREE_BUDGET_LIMIT = 2;
  const now = new Date();
  const thisMonth = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  const thisMonthTx = transactions.filter(t => t.date.startsWith(thisMonth) && t.amount < 0);

  const spending = {};
  thisMonthTx.forEach(t => { spending[t.category] = (spending[t.category]||0) + Math.abs(t.amount); });

  const activeBudgets = Object.entries(budgets).filter(([,b]) => b.limit > 0);

  if (activeBudgets.length === 0) {
    el.innerHTML = `
      <div class="empty-state">
        <div class="icon" style="opacity:0.7">&#128202;</div>
        <h3>No budget limits set</h3>
        <p>Define monthly spending caps per category. Visual progress bars alert you when you're approaching the limit.${!isPro ? ` Start with up to ${FREE_BUDGET_LIMIT} budgets free.` : ''}</p>
        <button class="btn btn-primary" onclick="openBudgetModal()">Set First Budget</button>
      </div>`;
    return;
  }

  const canAddMore = isPro || activeBudgets.length < FREE_BUDGET_LIMIT;
  el.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <div>
        <span style="font-size:.82rem;font-weight:600;color:var(--slate-500)">${activeBudgets.length} budget${activeBudgets.length===1?'':'s'} &middot; ${new Date().toLocaleString('en-US',{month:'long'})}${!isPro ? ` (${FREE_BUDGET_LIMIT - activeBudgets.length > 0 ? FREE_BUDGET_LIMIT - activeBudgets.length + ' free remaining' : 'free limit reached'})` : ''}</span>
      </div>
      <button class="btn" onclick="${canAddMore ? 'openBudgetModal()' : 'showUpgrade()'}">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Add${!canAddMore ? ' <span class=\"pro-badge\" style=\"margin-left:4px\">PRO</span>' : ''}
      </button>
    </div>
    <div class="budget-grid">
      ${activeBudgets.map(([cat, b]) => {
        const spent = spending[cat] || 0;
        const limit = b.limit;
        const pct = Math.min(Math.round((spent / limit) * 100), 150);
        const displayPct = Math.min(pct, 100);
        const color = pct > 100 ? 'var(--red)' : pct >= 75 ? 'var(--amber)' : catColor(cat);
        return `
          <div class="budget-item">
            <div class="budget-item-head">
              <span class="budget-item-name" style="color:${catColor(cat)}">${CATEGORIES[cat]?.name || cat}</span>
              <button class="budget-item-edit" onclick="openBudgetModal('${cat}')" title="Edit">&#9998;</button>
            </div>
            <div style="font-size:.78rem;color:var(--slate-500);margin-bottom:8px;font-variant-numeric:tabular-nums">${fmt(-spent)} of ${fmt(-limit)}</div>
            <div class="budget-bar"><div class="budget-bar-fill" style="width:${displayPct}%;background:${color}"></div></div>
            <div class="budget-pct" style="color:${pct>100?'var(--red)':pct>=75?'var(--amber)':'var(--slate-400)'}">${pct}%${pct>100?' — over budget!':pct>=75?' — approaching limit':''}</div>
          </div>`;
      }).join('')}
    </div>`;
}

function openBudgetModal(editCat) {
  const sel = $('budgetCategory');
  sel.innerHTML = Object.entries(CATEGORIES)
    .filter(([k]) => k !== 'income' && k !== 'transfer')
    .map(([k,v]) => `<option value="${k}" ${editCat===k?'selected':''}>${v.name}</option>`)
    .join('');
  if (editCat && budgets[editCat]) {
    $('budgetModalTitle').textContent = 'Edit Budget Limit';
    $('budgetLimit').value = budgets[editCat].limit;
    $('budgetDelete').style.display = 'inline-flex';
  } else {
    $('budgetModalTitle').textContent = 'Set Budget Limit';
    $('budgetLimit').value = '';
    $('budgetDelete').style.display = 'none';
  }
  $('budgetModal').classList.add('open');
}

$('budgetCancel').addEventListener('click', () => $('budgetModal').classList.remove('open'));
$('budgetModal').addEventListener('click', e => { if(e.target===$('budgetModal')) $('budgetModal').classList.remove('open'); });
$('budgetSave').addEventListener('click', async () => {
  const cat = $('budgetCategory').value;
  const limit = parseFloat($('budgetLimit').value) || 0;
  if (limit <= 0) { toast('Enter a valid limit'); return; }
  // Gate 3rd+ budget behind Pro
  const activeBudgetCount = Object.values(budgets).filter(b => b.limit > 0).length;
  const isEditing = budgets[cat] && budgets[cat].limit > 0;
  if (!isPro && !isEditing && activeBudgetCount >= 2) { showUpgrade(); return; }
  budgets[cat] = { category: cat, limit, period: 'monthly' };
  await dbPut('budgets', budgets[cat]);
  $('budgetModal').classList.remove('open');
  toast(`Budget: ${CATEGORIES[cat]?.name} — ${fmt(-limit)}/mo`);
  render();
});
$('budgetDelete').addEventListener('click', async () => {
  const cat = $('budgetCategory').value;
  if (budgets[cat]) {
    delete budgets[cat];
    const tx = db.transaction('budgets', 'readwrite');
    tx.objectStore('budgets').delete(cat);
    await new Promise(r => { tx.oncomplete = r; });
  }
  $('budgetModal').classList.remove('open');
  toast('Budget removed');
  render();
});

// ===== BUDGET SUMMARY CARD =====
function getBudgetSummaryCard() {
  const now = new Date();
  const thisMonth = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  const thisMonthTx = transactions.filter(t => t.date.startsWith(thisMonth) && t.amount < 0);
  const spending = {};
  thisMonthTx.forEach(t => { spending[t.category] = (spending[t.category]||0) + Math.abs(t.amount); });
  const activeBudgets = Object.entries(budgets).filter(([,b]) => b.limit > 0);

  if (activeBudgets.length === 0 && !isPro) {
    return `<div class="budget-summary-card locked-overlay" style="position:relative;min-height:100px">
      <h4>Budget Limits</h4>
      <div class="budget-mini-bars" style="filter:blur(3px)">
        <div class="budget-mini-row"><span class="bm-name">Groceries</span><div class="bm-bar"><div class="bm-fill" style="width:65%;background:var(--teal)"></div></div><span class="bm-pct">65%</span></div>
        <div class="budget-mini-row"><span class="bm-name">Dining Out</span><div class="bm-bar"><div class="bm-fill" style="width:82%;background:var(--amber)"></div></div><span class="bm-pct">82%</span></div>
        <div class="budget-mini-row"><span class="bm-name">Shopping</span><div class="bm-bar"><div class="bm-fill" style="width:110%;background:var(--red)"></div></div><span class="bm-pct">110%</span></div>
      </div>
      ${proLockedHTML('Budget Limits')}
    </div>`;
  }
  if (activeBudgets.length === 0) return '';

  const onTrack = activeBudgets.filter(([cat, b]) => (spending[cat]||0) <= b.limit).length;
  return `<div class="budget-summary-card">
    <h4 style="display:flex;align-items:center;justify-content:space-between">
      Budget Limits
      <span style="font-size:.72rem;font-weight:600;color:${onTrack===activeBudgets.length?'var(--teal-dark)':'var(--amber)'}">${onTrack} of ${activeBudgets.length} on track</span>
    </h4>
    <div class="budget-mini-bars">
      ${activeBudgets.slice(0,4).map(([cat, b]) => {
        const spent = spending[cat] || 0;
        const pct = Math.min(Math.round((spent / b.limit) * 100), 150);
        const displayPct = Math.min(pct, 100);
        const color = pct > 100 ? 'var(--red)' : pct >= 75 ? 'var(--amber)' : catColor(cat);
        return `<div class="budget-mini-row">
          <span class="bm-name">${CATEGORIES[cat]?.name || cat}</span>
          <div class="bm-bar"><div class="bm-fill" style="width:${displayPct}%;background:${color}"></div></div>
          <span class="bm-pct" style="color:${color}">${pct}%</span>
        </div>`;
      }).join('')}
    </div>
    ${activeBudgets.length > 4 ? `<div style="font-size:.68rem;color:var(--slate-400);margin-top:4px;text-align:right">+${activeBudgets.length-4} more</div>` : ''}
  </div>`;
}

// ===== RECEIPT PHOTOS =====
function compressImage(file, maxDim, quality) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = e => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let w = img.width, h = img.height;
        if (w > maxDim || h > maxDim) {
          if (w > h) { h = Math.round(h * maxDim / w); w = maxDim; }
          else { w = Math.round(w * maxDim / h); h = maxDim; }
        }
        canvas.width = w; canvas.height = h;
        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
        resolve(canvas.toDataURL('image/jpeg', quality || 0.7));
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

function showReceiptLightbox(txId) {
  const tx = transactions.find(t => t.id === txId);
  if (!tx || !tx.receipt) return;
  const lb = $('receiptLightbox');
  lb.style.display = 'flex';
  lb.className = 'receipt-lightbox';
  lb.innerHTML = `
    <button class="receipt-lightbox-close" onclick="closeReceiptLightbox()">&times;</button>
    <img src="${tx.receipt}" alt="Receipt">
    <div class="receipt-lightbox-actions">
      <button class="btn" style="background:rgba(255,255,255,0.15);color:white;border-color:rgba(255,255,255,0.3)" onclick="deleteReceipt(${txId})">Delete Receipt</button>
    </div>`;
  lb.addEventListener('click', e => { if (e.target === lb) closeReceiptLightbox(); });
}

function closeReceiptLightbox() {
  const lb = $('receiptLightbox');
  lb.style.display = 'none';
  lb.innerHTML = '';
}

async function deleteReceiptFromModal(txId) {
  const tx = transactions.find(t => t.id === txId);
  if (!tx) return;
  tx.receipt = null;
  await dbPut('transactions', tx);
  $('txReceiptPreview').innerHTML = '';
  toast('Receipt removed');
}

async function deleteReceipt(txId) {
  const tx = transactions.find(t => t.id === txId);
  if (!tx) return;
  tx.receipt = null;
  await dbPut('transactions', tx);
  closeReceiptLightbox();
  toast('Receipt removed');
  render();
}

async function attachReceipt(txId, file) {
  const dataUrl = await compressImage(file, 800, 0.7);
  const tx = transactions.find(t => t.id === txId);
  if (!tx) return;
  tx.receipt = dataUrl;
  await dbPut('transactions', tx);
  toast('Receipt attached');
  render();
}

function formatDisplayDate(d) {
  const [y,m,day] = d.split('-');
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return `${months[parseInt(m)-1]} ${parseInt(day)}, ${y}`;
}

// ===== CHARTS =====
function darkenColor(hex, factor) {
  const r = parseInt(hex.slice(1,3), 16);
  const g = parseInt(hex.slice(3,5), 16);
  const b = parseInt(hex.slice(5,7), 16);
  return `rgb(${Math.round(r*factor)},${Math.round(g*factor)},${Math.round(b*factor)})`;
}

function drawDonut(data) {
  const canvas = $('donutChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  canvas.width = rect.width * dpr; canvas.height = rect.height * dpr;
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  const w = rect.width, h = rect.height;

  const entries = Object.entries(data).sort((a,b) => b[1]-a[1]);
  const total = entries.reduce((s, [,v]) => s+v, 0);
  if (total === 0) return;

  const mobile = w < 300;
  const cx = mobile ? w/2 : w * 0.35, cy = h/2, r = Math.min(mobile ? w/2 : cx, cy) * 0.85, inner = r * 0.55;
  let angle = -Math.PI/2;

  const isDark = document.documentElement.classList.contains('dark');

  entries.forEach(([cat, val]) => {
    const sweep = (val/total) * Math.PI * 2;
    ctx.beginPath();
    ctx.arc(cx, cy, r, angle, angle + sweep);
    ctx.arc(cx, cy, inner, angle + sweep, angle, true);
    ctx.closePath();
    const rawColor = catColor(cat);
    ctx.fillStyle = isDark ? darkenColor(rawColor, 0.6) : rawColor;
    ctx.fill();
    angle += sweep;
  });

  // Center text
  ctx.fillStyle = isDark ? '#EAE4F0' : '#0F172A';
  ctx.font = 'bold 16px system-ui';
  ctx.textAlign = 'center';
  ctx.fillText(fmt(-total), cx, cy - 2);
  ctx.font = '10px system-ui';
  ctx.fillStyle = isDark ? '#9B95AD' : '#64748B';
  ctx.fillText('this month', cx, cy + 14);

  // Legend
  const legend = $('donutLegend');
  if (legend) {
    legend.innerHTML = entries.map(([cat, val]) => {
      const c = catColor(cat);
      const displayColor = isDark ? darkenColor(c, 0.6) : c;
      return `<span class="legend-item"><span class="legend-dot" style="background:${displayColor}"></span>${CATEGORIES[cat]?.name} ${fmt(-val)}</span>`;
    }).join('');
  }
}

function drawTrend() {
  const canvas = $('trendChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  canvas.width = rect.width * dpr; canvas.height = rect.height * dpr;
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  const w = rect.width, h = rect.height;

  const now = new Date();
  const months = [];
  for (let i = 5; i >= 0; i--) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    months.push({ key, label: monthNames[d.getMonth()] });
  }

  const incomeData = months.map(m => transactions.filter(t => t.date.startsWith(m.key) && t.amount > 0).reduce((s,t) => s+t.amount, 0));
  const spendData = months.map(m => Math.abs(transactions.filter(t => t.date.startsWith(m.key) && t.amount < 0).reduce((s,t) => s+t.amount, 0)));

  const maxVal = Math.max(...incomeData, ...spendData, 100);
  const pad = { top: 20, right: 20, bottom: 35, left: 60 };
  const cw = w - pad.left - pad.right;
  const ch = h - pad.top - pad.bottom;
  const barW = cw / months.length * 0.35;
  const dk = document.documentElement.classList.contains('dark');
  const gridClr = dk ? '#352F45' : '#E2E8F0';
  const txtClr = dk ? '#9B95AD' : '#64748B';

  // Grid lines
  ctx.strokeStyle = gridClr;
  ctx.lineWidth = 0.5;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + (ch / 4) * i;
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(w - pad.right, y); ctx.stroke();
    ctx.fillStyle = txtClr;
    ctx.font = '10px system-ui';
    ctx.textAlign = 'right';
    ctx.fillText(fmt(maxVal - (maxVal/4)*i).replace('.00',''), pad.left - 8, y + 3);
  }

  // Bars
  months.forEach((m, i) => {
    const x = pad.left + (cw / months.length) * i + (cw / months.length) * 0.15;
    const incH = (incomeData[i] / maxVal) * ch;
    const spendH = (spendData[i] / maxVal) * ch;

    // Income bar
    ctx.fillStyle = dk ? '#2D2868' : '#E0E7FF';
    ctx.beginPath();
    const ir = Math.min(barW/2, 4);
    roundRect(ctx, x, pad.top + ch - incH, barW, incH, ir);
    ctx.fill();

    // Spend bar
    ctx.fillStyle = dk ? darkenColor('#14B8A6', 0.6) : '#14B8A6';
    ctx.beginPath();
    roundRect(ctx, x + barW + 3, pad.top + ch - spendH, barW, spendH, ir);
    ctx.fill();

    // Label
    ctx.fillStyle = txtClr;
    ctx.font = '10px system-ui';
    ctx.textAlign = 'center';
    ctx.fillText(m.label, x + barW + 1, h - pad.bottom + 16);
  });

  // Mini legend
  ctx.fillStyle = dk ? '#2D2868' : '#E0E7FF';
  ctx.fillRect(w - 120, 8, 10, 10);
  ctx.fillStyle = txtClr; ctx.font = '10px system-ui'; ctx.textAlign = 'left';
  ctx.fillText('Income', w - 106, 17);
  ctx.fillStyle = '#14B8A6';
  ctx.fillRect(w - 60, 8, 10, 10);
  ctx.fillStyle = txtClr;
  ctx.fillText('Spend', w - 46, 17);
}

function roundRect(ctx, x, y, w, h, r) {
  if (h <= 0) return;
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r);
  ctx.lineTo(x + w, y + h);
  ctx.lineTo(x, y + h);
  ctx.lineTo(x, y + r);
  ctx.quadraticCurveTo(x, y, x + r, y);
}

// ===== EVENTS =====
document.querySelectorAll('.nav-item[data-view]').forEach(btn => {
  btn.addEventListener('click', () => switchView(btn.dataset.view));
});

$('btnImport').addEventListener('click', () => { $('importModal').classList.add('open'); });
$('navImport').addEventListener('click', () => { $('importModal').classList.add('open'); });
$('importCancel').addEventListener('click', () => { $('importModal').classList.remove('open'); $('importPreview').innerHTML=''; $('importConfirm').style.display='none'; fi.value=''; });
$('importModal').addEventListener('click', e => { if(e.target===$('importModal')){$('importModal').classList.remove('open');} });

// Drop zone
const dz = $('dropZone');
const fi = $('fileInput');
dz.addEventListener('click', () => fi.click());
dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('drag'); });
dz.addEventListener('dragleave', () => dz.classList.remove('drag'));
dz.addEventListener('drop', e => { e.preventDefault(); dz.classList.remove('drag'); handleFile(e.dataTransfer.files[0]); });
fi.addEventListener('change', e => { if(e.target.files[0]) handleFile(e.target.files[0]); });

let pendingImport = [];

function handleFile(file) {
  if (!file) { toast('No file selected'); return; }
  const ext = file?.name?.split('.').pop()?.toLowerCase() || '';
  // Accept any file — Android content URIs often lack proper extensions
  if (ext && !['csv','ofx','qfx','txt'].includes(ext)) {
    console.warn('File may not be a supported format:', file.name, file.type);
  }
  const reader = new FileReader();
  reader.onerror = () => { toast('Could not read file. Try copying it to Downloads first.'); };
  reader.onload = e => {
    const fileText = e.target.result;
    if (!fileText || fileText.trim().length === 0) { toast('File is empty'); return; }
    const isOFX = ext === 'ofx' || ext === 'qfx' || fileText.trim().startsWith('OFXHEADER') || fileText.includes('<OFX>');
    let bank = null;
    if (isOFX) {
      pendingImport = parseOFX(fileText);
      const orgMatch = fileText.match(/<ORG>([^<\r\n]+)/i);
      if (orgMatch) bank = { name: orgMatch[1].trim(), color: 'var(--teal-dark)' };
    } else {
      const lines = fileText.trim().split(/\r?\n/);
      bank = detectBank(lines[0], lines.slice(0,5).join('\n'));
      pendingImport = parseCSV(fileText);
    }
    if (pendingImport.length === 0) { toast('Could not parse any transactions. Check the file format.'); return; }

    // Compute summary stats
    const dates = pendingImport.map(t => t.date).sort();
    const dateRange = dates.length ? `${formatDisplayDate(dates[0])} — ${formatDisplayDate(dates[dates.length-1])}` : '';
    const totalIn = pendingImport.filter(t=>t.amount>0).reduce((s,t)=>s+t.amount,0);
    const totalOut = Math.abs(pendingImport.filter(t=>t.amount<0).reduce((s,t)=>s+t.amount,0));
    const catCounts = {};
    pendingImport.forEach(t => { catCounts[t.category] = (catCounts[t.category]||0) + 1; });
    const topCats = Object.entries(catCounts).sort((a,b)=>b[1]-a[1]).slice(0,4);

    const preview = $('importPreview');
    preview.innerHTML = `
      ${bank ? `<div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;padding:8px 12px;background:var(--slate-50);border-radius:8px;border-left:3px solid ${bank.color}">
        <span style="font-weight:700;color:${bank.color};font-size:.84rem">${bank.name}</span>
        <span style="font-size:.72rem;color:var(--teal-dark);background:var(--teal-light);padding:1px 8px;border-radius:6px;font-weight:600">Format detected</span>
      </div>` : ''}
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px">
        <div style="text-align:center;padding:8px;background:var(--slate-50);border-radius:8px">
          <div style="font-size:.65rem;color:var(--slate-400);text-transform:uppercase;letter-spacing:.5px">Records</div>
          <div style="font-size:1.1em;font-weight:700;color:var(--slate)">${pendingImport.length}</div>
        </div>
        <div style="text-align:center;padding:8px;background:var(--slate-50);border-radius:8px">
          <div style="font-size:.65rem;color:var(--slate-400);text-transform:uppercase;letter-spacing:.5px">Inflows</div>
          <div style="font-size:1.1em;font-weight:700;color:var(--teal-dark)">${fmt(totalIn)}</div>
        </div>
        <div style="text-align:center;padding:8px;background:var(--slate-50);border-radius:8px">
          <div style="font-size:.65rem;color:var(--slate-400);text-transform:uppercase;letter-spacing:.5px">Outflows</div>
          <div style="font-size:1.1em;font-weight:700;color:var(--slate)">${fmt(-totalOut)}</div>
        </div>
      </div>
      ${dateRange ? `<div style="font-size:.72rem;color:var(--slate-500);margin-bottom:8px">${dateRange}</div>` : ''}
      <div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:12px">
        ${topCats.map(([cat,n]) => `<span style="font-size:.68rem;padding:2px 8px;border-radius:6px;background:${catBg(cat)};color:${catColor(cat)};font-weight:600">${CATEGORIES[cat]?.name} (${n})</span>`).join('')}
      </div>
      <table class="preview-table">
        <thead><tr><th>Date</th><th>Description</th><th>Category</th><th>Amount</th></tr></thead>
        <tbody>${pendingImport.slice(0,5).map(t => `
          <tr>
            <td>${t.date}</td>
            <td>${esc(t.description.slice(0,30))}</td>
            <td>${CATEGORIES[t.category]?.name}</td>
            <td>${fmt(t.amount)}</td>
          </tr>`).join('')}
          ${pendingImport.length > 5 ? `<tr><td colspan="4" style="color:var(--slate-400)">...and ${pendingImport.length-5} more</td></tr>` : ''}
        </tbody>
      </table>`;
    $('importConfirm').style.display = 'inline-flex';
  };
  reader.readAsText(file);
}

$('importConfirm').addEventListener('click', async () => {
  // Deduplicate against existing transactions
  const h = t => `${t.date}|${t.description}|${t.amount}`;
  const existing = new Set(transactions.map(h));
  const newTx = pendingImport.filter(t => !existing.has(h(t)));
  const dupes = pendingImport.length - newTx.length;
  if (newTx.length > 0) await dbAdd('transactions', newTx);
  transactions = await dbGetAll('transactions');
  $('importModal').classList.remove('open');
  $('importPreview').innerHTML = '';
  $('importConfirm').style.display = 'none';
  fi.value = '';
  toast(dupes > 0 ? `Imported ${newTx.length} transactions (${dupes} duplicates skipped)` : `Imported ${newTx.length} transactions`);
  pendingImport = [];
  render();
});

$('btnDemo').addEventListener('click', () => loadDemo());

async function loadDemo() {
  if (transactions.length > 0) {
    if (!confirm('Clear all data and load fresh demo transactions?')) return;
  }
  const demo = generateDemo();
  await dbClear('transactions');
  await dbAdd('transactions', demo);
  transactions = await dbGetAll('transactions');
  toast(`Loaded ${demo.length} demo transactions`);
  render();
}

async function clearAllData() {
  if (transactions.length === 0) { toast('No data to clear'); return; }
  if (!confirm(`Delete all ${transactions.length} transactions? This cannot be undone.`)) return;
  await dbClear('transactions');
  await dbClear('budgets');
  transactions = [];
  localStorage.removeItem('verso_pro');
  isPro = false;
  updateProUI();
  toast('All data cleared');
  render();
}

$('navExport').addEventListener('click', async () => {
  const data = await dbGetAll('transactions');
  const csv = 'Date,Description,Category,Amount\n' + data.map(t =>
    `${t.date},"${t.description.replace(/"/g, '""')}",${t.category},${t.amount}`
  ).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `verso-export-${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  setTimeout(() => URL.revokeObjectURL(a.href), 3000);
  toast('Data exported as CSV');
});

// Toast
let toastT = null;
function toast(msg) {
  const el = $('toast');
  el.textContent = msg; el.classList.add('show');
  clearTimeout(toastT);
  toastT = setTimeout(() => el.classList.remove('show'), 3500);
}

// ===== SAVINGS GOALS =====
function renderGoals(el) {
  el.innerHTML = `
    <div class="goals-grid">
      ${goals.map(g => {
        const pct = g.target > 0 ? Math.min(Math.round((g.saved / g.target) * 100), 100) : 0;
        const remaining = Math.max(g.target - g.saved, 0);
        let daysLeft = '';
        if (g.deadline) {
          const dl = new Date(g.deadline);
          const diff = Math.ceil((dl - new Date()) / (1000*60*60*24));
          daysLeft = diff > 0 ? `${diff} days left` : (diff === 0 ? 'Due today!' : 'Past deadline');
        }
        return `
        <div class="goal-card">
          <div class="goal-emoji">${g.emoji || '\u{1F3AF}'}</div>
          <div class="goal-name">${g.name}</div>
          <div class="goal-target">${fmt(remaining)} to go${daysLeft ? ' \u00B7 ' + daysLeft : ''}</div>
          <div class="goal-progress"><div class="goal-progress-fill" style="width:${pct}%"></div></div>
          <div class="goal-stats">
            <span class="goal-amount">${fmt(g.saved)} / ${fmt(g.target)}</span>
            <span class="goal-pct">${pct}%</span>
          </div>
          ${pct >= 100 ? '<div style="text-align:center;margin-top:8px;font-size:.82rem;color:var(--green-dark);font-weight:600">\u{1F389} Goal reached!</div>' : ''}
        </div>`;
      }).join('')}
      <div class="add-goal" onclick="${isPro || goals.length < 3 ? "$('goalModal').classList.add('open')" : 'showUpgrade()'}">
        <div class="icon">${!isPro && goals.length >= 3 ? '\u{1F512}' : '\u2795'}</div>
        <p>${!isPro && goals.length >= 3 ? 'Upgrade to Pro for unlimited goals' : 'Add a savings goal'}</p>
      </div>
    </div>
    ${goals.length === 0 ? `
    <div style="text-align:center;padding:30px 20px;color:var(--slate-400);font-size:.88rem">
      <div style="font-size:2.5em;margin-bottom:8px">\u{1F3AF}</div>
      <strong style="color:var(--slate-700)">No goals yet!</strong><br>
      Set a savings goal \u2014 like an emergency fund, vacation, or new laptop \u2014 and track your progress here.
    </div>` : ''}`;
}

// Goal modal events
$('goalCancel').addEventListener('click', () => { $('goalModal').classList.remove('open'); });
$('goalModal').addEventListener('click', e => { if(e.target===$('goalModal')) $('goalModal').classList.remove('open'); });
$('goalSave').addEventListener('click', async () => {
  const name = $('goalName').value.trim();
  const emoji = $('goalEmoji').value;
  const target = parseFloat($('goalTarget').value) || 0;
  const saved = parseFloat($('goalSaved').value) || 0;
  const deadline = $('goalDate').value || null;
  if (!name || target <= 0) { toast('Please enter a name and target amount'); return; }
  const goal = { name, emoji, target, saved, deadline };
  await dbAdd('goals', [goal]);
  goals = await dbGetAll('goals');
  $('goalModal').classList.remove('open');
  $('goalName').value = ''; $('goalTarget').value = ''; $('goalSaved').value = '0'; $('goalDate').value = '';
  toast(`Goal "${name}" created!`);
  render();
});

// ===== ENCRYPTION (AES-256-GCM + PBKDF2) =====
async function deriveKey(pass, salt) {
  const km = await crypto.subtle.importKey('raw', new TextEncoder().encode(pass), 'PBKDF2', false, ['deriveKey']);
  return crypto.subtle.deriveKey({ name:'PBKDF2', salt, iterations:100000, hash:'SHA-256' }, km, { name:'AES-GCM', length:256 }, false, ['encrypt','decrypt']);
}
async function encryptData(data, pass) {
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const key = await deriveKey(pass, salt);
  const enc = await crypto.subtle.encrypt({ name:'AES-GCM', iv }, key, new TextEncoder().encode(JSON.stringify(data)));
  const buf = new Uint8Array(28 + enc.byteLength);
  buf.set(salt, 0); buf.set(iv, 16); buf.set(new Uint8Array(enc), 28);
  return buf;
}
async function decryptData(buf, pass) {
  const key = await deriveKey(pass, buf.slice(0,16));
  const dec = await crypto.subtle.decrypt({ name:'AES-GCM', iv:buf.slice(16,28) }, key, buf.slice(28));
  return JSON.parse(new TextDecoder().decode(dec));
}

// ===== WIRELESS PEER SYNC (WebRTC via PeerJS) =====
let syncPeer = null, syncConn = null;
function loadPeerJS() {
  return new Promise((res, rej) => {
    if (window.Peer) return res();
    const s = document.createElement('script');
    s.src = 'https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js';
    s.onload = res; s.onerror = () => rej(new Error('Could not load sync library'));
    document.head.appendChild(s);
  });
}
function cleanupSync() {
  if (syncConn) { try{syncConn.close();}catch(e){} syncConn=null; }
  if (syncPeer) { try{syncPeer.destroy();}catch(e){} syncPeer=null; }
}

function renderSync(el) {
  if (!isPro) {
    el.innerHTML = `
      <div class="sync-hero">
        <div class="icon">🔐</div>
        <h3>Encrypted Peer Sync <span class="pro-badge">PRO</span></h3>
        <p>Sync your financial data between devices with military-grade AES-256-GCM encryption. Zero-knowledge — no intermediary ever sees your data.</p>
        <div style="margin-top:20px">
          <div class="upgrade-cta" onclick="showUpgrade()" style="max-width:400px;margin:0 auto">
            <div class="icon">&#9889;</div>
            <div class="text">
              <div class="title">Unlock Encrypted Sync</div>
              <div class="desc">Upgrade to Pro for peer-to-peer encrypted device sync</div>
            </div>
            <div class="arrow">&#8250;</div>
          </div>
        </div>
      </div>`;
    return;
  }
  el.innerHTML = `
    <div class="sync-hero">
      <div class="icon">🔐</div>
      <h3>Encrypted Peer Sync</h3>
      <p>Open Verso on both devices with the same passphrase. Data transfers peer-to-peer with AES-256-GCM encryption. No intermediary ever sees your data.</p>
    </div>
    <div style="max-width:400px;margin:0 auto 20px">
      <label style="font-size:.78rem;font-weight:600;color:var(--slate-700);display:block;margin-bottom:4px">Encryption Passphrase</label>
      <input type="password" class="sync-input" id="syncPass" placeholder="Shared passphrase (6+ characters)" autocomplete="off">
    </div>
    <div class="sync-grid">
      <div class="sync-card">
        <h4>📡 Create Session</h4>
        <p>Generate a session code. The other device connects using this code — data flows directly between peers.</p>
        <button class="btn btn-primary" style="width:100%" id="syncHostBtn">Create Session</button>
        <div id="syncHostArea"></div>
      </div>
      <div class="sync-card">
        <h4>🔗 Join Session</h4>
        <p>Enter the session code from your other device to establish an encrypted peer connection.</p>
        <div style="display:flex;gap:8px;align-items:flex-start">
          <input type="text" class="sync-input" id="syncCode" placeholder="A1B2C3" maxlength="6" style="text-align:center;font-size:1.1em;letter-spacing:3px;font-weight:700;font-family:'SF Mono',Consolas,monospace;margin-bottom:0;flex:1;text-transform:uppercase">
          <button class="btn btn-primary" id="syncJoinBtn" style="flex-shrink:0;height:44px">Connect</button>
        </div>
        <div id="syncJoinArea"></div>
      </div>
    </div>
    <details style="margin-top:24px">
      <summary style="font-size:.78rem;color:var(--slate-400);cursor:pointer;text-align:center">Offline? Export encrypted vault</summary>
      <div class="sync-card" style="max-width:500px;margin:12px auto 0">
        <h4>📁 Vault Export/Import</h4>
        <p>Transfer an encrypted .verso file manually.</p>
        <div style="display:flex;gap:8px">
          <button class="btn" style="flex:1" id="syncFileExport">Export .verso</button>
          <label class="btn" style="flex:1;cursor:pointer;text-align:center">Import .verso<input type="file" id="syncFileInput" accept=".verso" style="display:none"></label>
        </div>
        <div class="sync-status" id="syncFileStatus"></div>
      </div>
    </details>
    <div class="sync-tech" style="max-width:500px;margin:16px auto 0;text-align:center">
      WebRTC DataChannel · AES-256-GCM · PBKDF2-SHA256 (100k) · 128-bit salt · 96-bit IV · Zero-knowledge
    </div>`;
  initSyncHandlers();
}

function initSyncHandlers() {
  const getPass = () => $('syncPass')?.value || '';

  // HOST — alphanumeric code for Verso
  $('syncHostBtn').addEventListener('click', async () => {
    const pass = getPass();
    if (!pass || pass.length < 6) { toast('Passphrase must be at least 6 characters'); return; }
    const area = $('syncHostArea');
    area.innerHTML = '<div style="text-align:center;padding:16px;color:var(--slate-500);font-size:.82rem">Initializing...</div>';
    try {
      await loadPeerJS();
      cleanupSync();
      const chars = 'ABCDEFGHJKMNPQRSTUVWXYZ23456789';
      const code = Array.from(crypto.getRandomValues(new Uint8Array(6))).map(b => chars[b % chars.length]).join('');
      syncPeer = new Peer('verso-' + code);
      syncPeer.on('open', () => {
        area.innerHTML = `
          <div style="text-align:center;padding:20px 0 8px">
            <div style="font-family:'SF Mono',Consolas,monospace;font-size:2em;font-weight:800;letter-spacing:6px;color:var(--teal-dark)">${code}</div>
            <div style="font-size:.72rem;color:var(--slate-400);margin-top:6px">Enter this on your other device</div>
            <div style="font-size:.7rem;color:var(--slate-400);margin-top:12px;display:flex;align-items:center;justify-content:center;gap:6px">
              <span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--teal);animation:pulse 1.5s infinite"></span>
              Awaiting peer connection...
            </div>
          </div>`;
      });
      syncPeer.on('connection', conn => { handleSyncConn(conn, pass, 'syncHostArea'); });
      syncPeer.on('error', e => { area.innerHTML = `<div class="sync-status show error" style="display:block;margin-top:12px">Error: ${e.type}</div>`; });
    } catch (e) { area.innerHTML = `<div class="sync-status show error" style="display:block;margin-top:12px">${e.message}</div>`; }
  });

  // JOIN
  $('syncJoinBtn').addEventListener('click', async () => {
    const pass = getPass();
    if (!pass || pass.length < 6) { toast('Enter the same passphrase as your other device'); return; }
    const code = ($('syncCode').value || '').replace(/\s/g, '').toUpperCase();
    if (code.length !== 6) { toast('Enter the 6-character session code'); return; }
    const area = $('syncJoinArea');
    area.innerHTML = '<div style="text-align:center;padding:12px;color:var(--slate-500);font-size:.82rem">Connecting...</div>';
    try {
      await loadPeerJS();
      cleanupSync();
      syncPeer = new Peer('verso-join-' + Math.random().toString(36).slice(2,8));
      syncPeer.on('open', () => {
        syncConn = syncPeer.connect('verso-' + code, { reliable:true });
        handleSyncConn(syncConn, pass, 'syncJoinArea');
      });
      syncPeer.on('error', e => {
        area.innerHTML = `<div class="sync-status show error" style="display:block;margin-top:12px">${e.type === 'peer-unavailable' ? 'Session not found. Verify the code.' : 'Connection failed.'}</div>`;
      });
    } catch (e) { area.innerHTML = `<div class="sync-status show error" style="display:block;margin-top:12px">${e.message}</div>`; }
  });

  // FILE BACKUP
  $('syncFileExport')?.addEventListener('click', async () => {
    const pass = getPass();
    if (!pass || pass.length < 6) { toast('Enter a passphrase (6+ chars)'); return; }
    try {
      const allTx = await dbGetAll('transactions');
      const allGoals = await dbGetAll('goals').catch(() => []);
      const allBudgets = await dbGetAll('budgets').catch(() => []);
      const enc = await encryptData({ transactions:allTx, goals:allGoals, budgets:allBudgets, app:'verso', version:1, exportDate:new Date().toISOString() }, pass);
      const a = document.createElement('a');
      const url = URL.createObjectURL(new Blob([enc]));
      a.href = url;
      a.download = `verso-vault-${new Date().toISOString().slice(0,10)}.verso`;
      a.click();
      setTimeout(() => URL.revokeObjectURL(url), 3000);
      showSyncStatus('syncFileStatus', `${allTx.length} transactions + ${allGoals.length} goals + ${allBudgets.length || 0} budgets encrypted and exported`, 'success');
    } catch(e) { showSyncStatus('syncFileStatus', e.message, 'error'); }
  });
  $('syncFileInput')?.addEventListener('change', async e => {
    const file = e.target.files[0]; if (!file) return;
    const pass = getPass();
    if (!pass) { toast('Enter passphrase'); return; }
    try {
      const imported = await decryptData(new Uint8Array(await file.arrayBuffer()), pass);
      if (!imported.transactions) throw new Error('Invalid vault');
      await applySyncMerge(imported);
      showSyncStatus('syncFileStatus', 'Vault decrypted and merged', 'success');
    } catch(e) { showSyncStatus('syncFileStatus', e.message.includes('decrypt')?'Decryption failed — wrong passphrase':e.message, 'error'); }
  });

  // Auto-uppercase code input
  $('syncCode').addEventListener('input', e => { e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,6); });
}

async function handleSyncConn(conn, pass, areaId) {
  syncConn = conn;
  conn.on('open', async () => {
    $(areaId).innerHTML = '<div style="text-align:center;padding:12px;color:var(--teal-dark);font-size:.82rem;font-weight:600">Peer connected. Encrypting...</div>';
    try {
      const allTx = await dbGetAll('transactions');
      const allGoals = await dbGetAll('goals').catch(() => []);
      const encrypted = await encryptData({ transactions:allTx, goals:allGoals, app:'verso', ts:Date.now() }, pass);
      conn.send({ type:'sync', payload:Array.from(encrypted) });
    } catch(e) { $(areaId).innerHTML = '<div class="sync-status show error" style="display:block;margin-top:12px">Encryption failed</div>'; }
  });
  conn.on('data', async msg => {
    if (msg.type === 'sync') {
      try {
        const imported = await decryptData(new Uint8Array(msg.payload), pass);
        const result = await applySyncMerge(imported);
        $(areaId).innerHTML = `
          <div style="text-align:center;padding:16px">
            <div style="font-size:1.8em;margin-bottom:4px">✅</div>
            <div style="font-weight:700;color:var(--teal-dark);margin-bottom:4px">Synced</div>
            <div style="font-size:.78rem;color:var(--slate-500)">${result.newTx} new transactions merged</div>
          </div>`;
        setTimeout(cleanupSync, 5000);
      } catch(e) {
        $(areaId).innerHTML = `<div class="sync-status show error" style="display:block;margin-top:12px">${e.message.includes('decrypt')?'Passphrase mismatch — both devices must use the same one':'Sync error: '+e.message}</div>`;
        cleanupSync();
      }
    }
  });
  conn.on('error', () => { $(areaId).innerHTML = '<div class="sync-status show error" style="display:block;margin-top:12px">Connection lost</div>'; });
}

async function applySyncMerge(imported) {
  const h = t => `${t.date}|${t.description}|${t.amount}`;
  const set = new Set(transactions.map(h));
  const newTx = imported.transactions.filter(t => !set.has(h(t)));
  if (newTx.length > 0) {
    await dbAdd('transactions', newTx);
    transactions = await dbGetAll('transactions');
  }
  // Merge goals if present
  let newGoals = 0;
  if (imported.goals && imported.goals.length > 0) {
    try {
      const existingGoals = await dbGetAll('goals');
      const gn = new Set(existingGoals.map(g => g.name));
      const addGoals = imported.goals.filter(g => !gn.has(g.name));
      if (addGoals.length > 0) {
        await dbAdd('goals', addGoals);
        goals = await dbGetAll('goals');
        newGoals = addGoals.length;
      }
    } catch(e) {}
  }
  // Merge budgets if present
  let newBudgets = 0;
  if (imported.budgets && imported.budgets.length > 0) {
    try {
      const existingBudgets = await dbGetAll('budgets');
      const bc = new Set(existingBudgets.map(b => b.category));
      const addBudgets = imported.budgets.filter(b => !bc.has(b.category));
      if (addBudgets.length > 0) {
        await dbAdd('budgets', addBudgets);
        budgets = await dbGetAll('budgets');
        newBudgets = addBudgets.length;
      }
    } catch(e) {}
  }
  return { newTx: newTx.length, newGoals, newBudgets };
}

function showSyncStatus(id, msg, type) {
  const el = $(id); if(!el) return;
  el.textContent = msg;
  el.className = 'sync-status show ' + type;
}

// ===== DARK MODE =====
function toggleDark() {
  const isDark = document.documentElement.classList.toggle('dark');
  localStorage.setItem('verso_dark', isDark ? '1' : '0');
  if (currentView === 'dashboard') render(); // redraw charts
}
if (localStorage.getItem('verso_dark') === '1') document.documentElement.classList.add('dark');
$('btnDarkToggle').addEventListener('click', toggleDark);

// ===== KEYBOARD SHORTCUTS =====
document.addEventListener('keydown', e => {
  // Don't fire when typing in inputs (except in pro key input)
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;

  if (e.ctrlKey && e.key === 'd') { e.preventDefault(); toggleDark(); return; }
  // Basic navigation is free; Escape always works
  if (e.key === 'Escape') {
    $('importModal').classList.remove('open');
    $('pasteModal').classList.remove('open');
    $('goalModal').classList.remove('open');
    $('kbHelp').classList.remove('open');
    $('purgeModal').classList.remove('open');
    closeTxModal();
    return;
  }

  const keyMap = { d:'dashboard', t:'transactions', b:'budgets', g:'goals', s:'sync' };
  if (keyMap[e.key]) switchView(keyMap[e.key]);
  if (e.key === 'i') $('importModal').classList.add('open');
  if (e.key === 'p') openPasteModal();
  if (e.key === 'e') $('navExport').click();
  if (e.key === '?') $('kbHelp').classList.add('open');
});
$('btnKbHelp').addEventListener('click', () => $('kbHelp').classList.add('open'));
$('kbHelp').addEventListener('click', e => { if (e.target === $('kbHelp')) $('kbHelp').classList.remove('open'); });

// ===== DATA PURGE =====
$('btnPurge').addEventListener('click', () => { if (requirePro('Data Purge')) $('purgeModal').classList.add('open'); });
$('purgeCancel').addEventListener('click', () => $('purgeModal').classList.remove('open'));
$('purgeModal').addEventListener('click', e => { if (e.target === $('purgeModal')) $('purgeModal').classList.remove('open'); });
$('purgeConfirm').addEventListener('click', async () => {
  await dbClear('transactions');
  await dbClear('budgets');
  await dbClear('goals');
  transactions = [];
  budgets = {};
  goals = [];
  $('purgeModal').classList.remove('open');
  currentView = 'dashboard';
  toast('All data purged');
  render();
});

// ===== VIEW SWITCHING =====
const VIEW_ORDER = ['dashboard','transactions','budgets','goals','sync'];
const VIEW_TITLES = { dashboard:'Dashboard', transactions:'Transactions', budgets:'Budgets', goals:'Savings Goals', sync:'Encrypted Sync' };

function switchView(view) {
  if (view === currentView) return;
  const c = $('content');

  // Update state
  currentView = view;
  document.querySelectorAll('.nav-item,.bottom-nav-item').forEach(b => b.classList.remove('active'));
  document.querySelectorAll(`.nav-item[data-view="${view}"],.bottom-nav-item[data-view="${view}"]`).forEach(b => b.classList.add('active'));
  $('viewTitle').textContent = VIEW_TITLES[view];
  searchTerm = ''; filterCat = '';

  // Render new content
  render();
  c.style.opacity = '1';
  c.style.transform = '';
  c.style.transition = '';
}

// ===== BOTTOM NAV + MOBILE HANDLERS =====
document.querySelectorAll('.bottom-nav-item[data-view]').forEach(btn => {
  btn.addEventListener('click', () => switchView(btn.dataset.view));
});


// Mobile buttons
const btnMobile = $('btnImportMobile');
if (btnMobile) btnMobile.addEventListener('click', () => { $('importModal').classList.add('open'); });
const btnDemoMob = $('btnDemoMobile');
if (btnDemoMob) btnDemoMob.addEventListener('click', () => loadDemo());
const btnDarkMob = $('btnDarkMobile');
if (btnDarkMob) btnDarkMob.addEventListener('click', () => toggleDark());
const btnExportMob = $('btnExportMobile');
if (btnExportMob) btnExportMob.addEventListener('click', () => $('navExport').click());
const btnClearMob = $('btnClearMobile');
if (btnClearMob) btnClearMob.addEventListener('click', () => clearAllData());

// Redraw charts on resize
let resizeTimer;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(() => render(), 200);
});

// ===== ADD / EDIT TRANSACTION =====
let editingTxId = null;
let txType = 'outflow';

function buildCatGrid() {
  const grid = $('txCatGrid');
  if (!grid) return;
  grid.innerHTML = Object.entries(CATEGORIES).map(([k, v]) =>
    `<button type="button" class="tx-cat-btn" data-cat="${k}" style="${txType==='inflow'&&k==='income'?`border-color:${catColor(k)};border-width:2px;background:${catBg(k)};color:${catColor(k)}`:''}">${v.name}</button>`
  ).join('');
  grid.querySelectorAll('.tx-cat-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      grid.querySelectorAll('.tx-cat-btn').forEach(b => {
        b.classList.remove('selected');
        b.style.borderColor = '';
        b.style.borderWidth = '';
        b.style.background = '';
        b.style.color = '';
      });
      btn.classList.add('selected');
      const cat = btn.dataset.cat;
      btn.style.borderColor = catColor(cat);
      btn.style.borderWidth = '2px';
      btn.style.background = catBg(cat);
      btn.style.color = catColor(cat);
    });
  });
}

function openAddTxModal() {
  editingTxId = null;
  txType = 'outflow';
  $('txModalTitle').textContent = 'Add Transaction';
  $('txAmount').value = '';
  $('txDesc').value = '';
  $('txDate').value = new Date().toISOString().slice(0, 10);
  // Reset type toggle
  const toggleBtns = $('txTypeToggle').querySelectorAll('button');
  toggleBtns[0].className = 'active-outflow';
  toggleBtns[1].className = '';
  // Remove delete button if present
  const existingDel = $('txDeleteBtn');
  if (existingDel) existingDel.remove();
  // Show save button text
  $('txSave').textContent = 'Save';
  buildCatGrid();
  // Receipt - show for Pro users
  if (isPro) {
    $('txReceiptRow').style.display = '';
    $('txReceiptPreview').innerHTML = '';
    $('txReceiptInput').value = '';
  } else {
    $('txReceiptRow').style.display = 'none';
  }
  $('txModal').classList.add('open');
  setTimeout(() => $('txAmount').focus(), 100);
}

function openEditTxModal(txId) {
  const tx = transactions.find(t => t.id === txId);
  if (!tx) return;
  editingTxId = txId;
  txType = tx.amount >= 0 ? 'inflow' : 'outflow';
  $('txModalTitle').textContent = 'Edit Transaction';
  $('txAmount').value = Math.abs(tx.amount).toFixed(2);
  $('txDesc').value = tx.description;
  $('txDate').value = tx.date;
  // Set type toggle
  const toggleBtns = $('txTypeToggle').querySelectorAll('button');
  if (txType === 'outflow') {
    toggleBtns[0].className = 'active-outflow';
    toggleBtns[1].className = '';
  } else {
    toggleBtns[0].className = '';
    toggleBtns[1].className = 'active-inflow';
  }
  $('txSave').textContent = 'Save Changes';
  buildCatGrid();
  // Pre-select the category
  const catBtn = $('txCatGrid').querySelector(`[data-cat="${tx.category}"]`);
  if (catBtn) catBtn.click();
  // Add delete button if not present
  let delBtn = $('txDeleteBtn');
  if (!delBtn) {
    delBtn = document.createElement('button');
    delBtn.id = 'txDeleteBtn';
    delBtn.className = 'btn btn-danger';
    delBtn.textContent = 'Delete';
    $('txModalActions').insertBefore(delBtn, $('txSave'));
  }
  delBtn.onclick = async () => {
    if (!confirm('Delete this transaction?')) return;
    const txObj = db.transaction('transactions', 'readwrite');
    txObj.objectStore('transactions').delete(txId);
    await new Promise(r => { txObj.oncomplete = r; });
    transactions = transactions.filter(t => t.id !== txId);
    $('txModal').classList.remove('open');
    toast('Transaction deleted');
    render();
  };
  // Receipt
  if (isPro) {
    $('txReceiptRow').style.display = '';
    $('txReceiptPreview').innerHTML = tx.receipt
      ? `<img src="${tx.receipt}" style="max-width:120px;max-height:120px;border-radius:8px;border:1px solid var(--slate-200)"> <button class="btn" style="font-size:.75rem;padding:4px 10px;vertical-align:top" onclick="deleteReceiptFromModal(${txId})">Remove</button>`
      : '';
    $('txReceiptInput').value = '';
  } else {
    $('txReceiptRow').style.display = 'none';
  }
  $('txModal').classList.add('open');
}

function closeTxModal() {
  $('txModal').classList.remove('open');
  editingTxId = null;
  $('txReceiptRow').style.display = 'none';
  $('txReceiptPreview').innerHTML = '';
}

// FAB click
$('fabAdd').addEventListener('click', openAddTxModal);

// Cancel
$('txCancel').addEventListener('click', closeTxModal);

// Overlay close
$('txModal').addEventListener('click', e => { if (e.target === $('txModal')) closeTxModal(); });

// Type toggle
$('txTypeToggle').addEventListener('click', e => {
  const btn = e.target.closest('button');
  if (!btn) return;
  txType = btn.dataset.type;
  const btns = $('txTypeToggle').querySelectorAll('button');
  if (txType === 'outflow') {
    btns[0].className = 'active-outflow';
    btns[1].className = '';
  } else {
    btns[0].className = '';
    btns[1].className = 'active-inflow';
  }
});

// Save (add or edit)
$('txSave').addEventListener('click', async () => {
  const amountRaw = parseFloat($('txAmount').value);
  if (!amountRaw || amountRaw <= 0) { toast('Enter a valid amount'); return; }
  const desc = $('txDesc').value.trim();
  if (!desc) { toast('Enter a description'); return; }
  const date = $('txDate').value;
  if (!date) { toast('Pick a date'); return; }
  const selCat = $('txCatGrid').querySelector('.tx-cat-btn.selected');
  const category = selCat ? selCat.dataset.cat : (txType === 'inflow' ? 'income' : 'other');
  const amount = txType === 'outflow' ? -Math.abs(amountRaw) : Math.abs(amountRaw);

  if (editingTxId !== null) {
    // Edit existing
    const tx = transactions.find(t => t.id === editingTxId);
    if (tx) {
      tx.date = date;
      tx.description = desc;
      tx.amount = Math.round(amount * 100) / 100;
      tx.category = category;
      // Handle receipt from modal
      const receiptFile = $('txReceiptInput').files[0];
      if (receiptFile) {
        tx.receipt = await compressImage(receiptFile, 800, 0.7);
      }
      await dbPut('transactions', tx);
      toast('Transaction updated');
    }
  } else {
    // Add new
    const newTx = { date, description: desc, amount: Math.round(amount * 100) / 100, category };
    const receiptFile2 = $('txReceiptInput').files[0];
    if (receiptFile2) {
      newTx.receipt = await compressImage(receiptFile2, 800, 0.7);
    }
    await dbAdd('transactions', [newTx]);
    transactions = await dbGetAll('transactions');
    toast('Transaction added');
  }

  closeTxModal();
  render();
});

// ===== PASTE MODAL =====
let pendingPaste = [];

function openPasteModal() {
  $('pasteModal').classList.add('open');
  $('pasteTextarea').value = '';
  $('pasteStats').innerHTML = '';
  $('pastePreview').innerHTML = '';
  $('pasteParse').style.display = 'inline-flex';
  $('pasteImport').style.display = 'none';
  pendingPaste = [];
  setTimeout(() => $('pasteTextarea').focus(), 100);
}

$('pasteCancel').addEventListener('click', () => {
  $('pasteModal').classList.remove('open');
  pendingPaste = [];
});
$('pasteModal').addEventListener('click', e => {
  if (e.target === $('pasteModal')) { $('pasteModal').classList.remove('open'); pendingPaste = []; }
});

$('pasteParse').addEventListener('click', () => {
  const text = $('pasteTextarea').value.trim();
  if (!text) { toast('Paste some transaction text first'); return; }
  pendingPaste = parsePastedText(text);
  if (pendingPaste.length === 0) {
    $('pasteStats').innerHTML = '<div style="padding:10px;color:var(--red);font-size:.82rem;font-weight:600">Could not parse any transactions. Each line needs a date and an amount.</div>';
    $('pastePreview').innerHTML = '';
    $('pasteImport').style.display = 'none';
    return;
  }

  const totalIn = pendingPaste.filter(t => t.amount > 0).reduce((s, t) => s + t.amount, 0);
  const totalOut = Math.abs(pendingPaste.filter(t => t.amount < 0).reduce((s, t) => s + t.amount, 0));
  const catCounts = {};
  pendingPaste.forEach(t => { catCounts[t.category] = (catCounts[t.category] || 0) + 1; });
  const topCats = Object.entries(catCounts).sort((a, b) => b[1] - a[1]).slice(0, 4);

  $('pasteStats').innerHTML = `
    <div class="paste-stats">
      <span class="paste-stat">${pendingPaste.length} found</span>
      ${totalIn > 0 ? `<span class="paste-stat" style="color:var(--teal-dark)">+${fmt(totalIn)}</span>` : ''}
      ${totalOut > 0 ? `<span class="paste-stat">${fmt(-totalOut)}</span>` : ''}
    </div>
    <div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px">
      ${topCats.map(([cat, n]) => `<span style="font-size:.68rem;padding:2px 8px;border-radius:6px;background:${catBg(cat)};color:${catColor(cat)};font-weight:600">${CATEGORIES[cat]?.name} (${n})</span>`).join('')}
    </div>`;

  $('pastePreview').innerHTML = `
    <table class="preview-table">
      <thead><tr><th>Date</th><th>Description</th><th>Category</th><th>Amount</th></tr></thead>
      <tbody>${pendingPaste.slice(0, 8).map(t => `
        <tr>
          <td>${t.date}</td>
          <td>${esc(t.description.slice(0, 30))}</td>
          <td>${CATEGORIES[t.category]?.name}</td>
          <td class="${t.amount >= 0 ? 'amount-pos' : 'amount-neg'}">${fmt(t.amount)}</td>
        </tr>`).join('')}
        ${pendingPaste.length > 8 ? `<tr><td colspan="4" style="color:var(--slate-400)">...and ${pendingPaste.length - 8} more</td></tr>` : ''}
      </tbody>
    </table>`;

  $('pasteParse').style.display = 'none';
  $('pasteImport').style.display = 'inline-flex';
});

$('pasteImport').addEventListener('click', async () => {
  if (pendingPaste.length === 0) return;
  const h = t => `${t.date}|${t.description}|${t.amount}`;
  const existing = new Set(transactions.map(h));
  const newTx = pendingPaste.filter(t => !existing.has(h(t)));
  const dupes = pendingPaste.length - newTx.length;
  if (newTx.length > 0) await dbAdd('transactions', newTx);
  transactions = await dbGetAll('transactions');
  $('pasteModal').classList.remove('open');
  toast(dupes > 0 ? `Imported ${newTx.length} transactions (${dupes} duplicates skipped)` : `Imported ${newTx.length} transactions from paste`);
  pendingPaste = [];
  render();
});

// Re-show parse button when text changes after a parse
$('pasteTextarea').addEventListener('input', () => {
  if ($('pasteImport').style.display !== 'none') {
    $('pasteParse').style.display = 'inline-flex';
    $('pasteImport').style.display = 'none';
    $('pasteStats').innerHTML = '';
    $('pastePreview').innerHTML = '';
    pendingPaste = [];
  }
});

// Paste button event handlers
$('btnPaste').addEventListener('click', openPasteModal);
$('navPaste').addEventListener('click', openPasteModal);

// ===== OVERFLOW MENU (MOBILE) =====
const overflowBtn = $('mobileOverflowBtn');
const overflowMenu = $('mobileOverflowMenu');
if (overflowBtn && overflowMenu) {
  overflowBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    overflowMenu.classList.toggle('open');
  });
  document.addEventListener('click', (e) => {
    if (!overflowMenu.contains(e.target) && e.target !== overflowBtn) {
      overflowMenu.classList.remove('open');
    }
  });
  // Close on item click
  overflowMenu.querySelectorAll('button').forEach(btn => {
    btn.addEventListener('click', () => overflowMenu.classList.remove('open'));
  });
}
const btnPasteMob = $('btnPasteMobile');
if (btnPasteMob) btnPasteMob.addEventListener('click', openPasteModal);

// ===== INIT =====
async function init() {
  await openDB();
  transactions = await dbGetAll('transactions');
  try {
    const budgetList = await dbGetAll('budgets');
    budgetList.forEach(b => { budgets[b.category] = b; });
  } catch(e) {}
  try { goals = await dbGetAll('goals'); } catch(e) { goals = []; }
  updateProUI();
  render();
}
init();

// ===== ANDROID BACK BUTTON =====
document.addEventListener('backbutton', function(e) {
  e.preventDefault();
  // 1. Close receipt lightbox
  const lb = $('receiptLightbox');
  if (lb && lb.style.display !== 'none' && lb.style.display !== '') { closeReceiptLightbox(); return; }
  // 2. Close tx modal
  const txM = $('txModal');
  if (txM && txM.classList.contains('open')) { closeTxModal(); return; }
  // 3. Close any open modal overlay
  const modals = ['importModal','budgetModal','goalModal','pasteModal','purgeModal','kbHelp','upgradeModal'];
  for (const id of modals) {
    const m = $(id);
    if (m && m.classList.contains('open')) { m.classList.remove('open'); return; }
  }
  // 4. Navigate back to dashboard
  if (currentView !== 'dashboard') { switchView('dashboard'); return; }
  // 5. Already on dashboard, nothing open — minimize app
  if (navigator.app) navigator.app.exitApp();
}, false);
</script>

<script>if('serviceWorker' in navigator){navigator.serviceWorker.register('sw.js')}</script>
</body>
</html>